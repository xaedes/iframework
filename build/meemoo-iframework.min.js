/*! Meemoo Iframework http://meemoo.org/ - v0.3.5 - 2013-10-26 (5:03:57 PM GMT+0200)
* Copyright (c) 2013 Forrest Oliphant; Licensed MIT, AGPL */
(function(){var a=this,b=a._,c={},d=Array.prototype,e=Object.prototype,f=Function.prototype,g=d.push,h=d.slice,i=d.concat,j=e.toString,k=e.hasOwnProperty,l=d.forEach,m=d.map,n=d.reduce,o=d.reduceRight,p=d.filter,q=d.every,r=d.some,s=d.indexOf,t=d.lastIndexOf,u=Array.isArray,v=Object.keys,w=f.bind,x=function(a){return a instanceof x?a:this instanceof x?(this._wrapped=a,void 0):new x(a)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=x),exports._=x):a._=x,x.VERSION="1.4.4";var y=x.each=x.forEach=function(a,b,d){if(null!=a)if(l&&a.forEach===l)a.forEach(b,d);else if(a.length===+a.length){for(var e=0,f=a.length;f>e;e++)if(b.call(d,a[e],e,a)===c)return}else for(var g in a)if(x.has(a,g)&&b.call(d,a[g],g,a)===c)return};x.map=x.collect=function(a,b,c){var d=[];return null==a?d:m&&a.map===m?a.map(b,c):(y(a,function(a,e,f){d[d.length]=b.call(c,a,e,f)}),d)};var z="Reduce of empty array with no initial value";x.reduce=x.foldl=x.inject=function(a,b,c,d){var e=arguments.length>2;if(null==a&&(a=[]),n&&a.reduce===n)return d&&(b=x.bind(b,d)),e?a.reduce(b,c):a.reduce(b);if(y(a,function(a,f,g){e?c=b.call(d,c,a,f,g):(c=a,e=!0)}),!e)throw new TypeError(z);return c},x.reduceRight=x.foldr=function(a,b,c,d){var e=arguments.length>2;if(null==a&&(a=[]),o&&a.reduceRight===o)return d&&(b=x.bind(b,d)),e?a.reduceRight(b,c):a.reduceRight(b);var f=a.length;if(f!==+f){var g=x.keys(a);f=g.length}if(y(a,function(h,i,j){i=g?g[--f]:--f,e?c=b.call(d,c,a[i],i,j):(c=a[i],e=!0)}),!e)throw new TypeError(z);return c},x.find=x.detect=function(a,b,c){var d;return A(a,function(a,e,f){return b.call(c,a,e,f)?(d=a,!0):void 0}),d},x.filter=x.select=function(a,b,c){var d=[];return null==a?d:p&&a.filter===p?a.filter(b,c):(y(a,function(a,e,f){b.call(c,a,e,f)&&(d[d.length]=a)}),d)},x.reject=function(a,b,c){return x.filter(a,function(a,d,e){return!b.call(c,a,d,e)},c)},x.every=x.all=function(a,b,d){b||(b=x.identity);var e=!0;return null==a?e:q&&a.every===q?a.every(b,d):(y(a,function(a,f,g){return(e=e&&b.call(d,a,f,g))?void 0:c}),!!e)};var A=x.some=x.any=function(a,b,d){b||(b=x.identity);var e=!1;return null==a?e:r&&a.some===r?a.some(b,d):(y(a,function(a,f,g){return e||(e=b.call(d,a,f,g))?c:void 0}),!!e)};x.contains=x.include=function(a,b){return null==a?!1:s&&a.indexOf===s?-1!=a.indexOf(b):A(a,function(a){return a===b})},x.invoke=function(a,b){var c=h.call(arguments,2),d=x.isFunction(b);return x.map(a,function(a){return(d?b:a[b]).apply(a,c)})},x.pluck=function(a,b){return x.map(a,function(a){return a[b]})},x.where=function(a,b,c){return x.isEmpty(b)?c?null:[]:x[c?"find":"filter"](a,function(a){for(var c in b)if(b[c]!==a[c])return!1;return!0})},x.findWhere=function(a,b){return x.where(a,b,!0)},x.max=function(a,b,c){if(!b&&x.isArray(a)&&a[0]===+a[0]&&65535>a.length)return Math.max.apply(Math,a);if(!b&&x.isEmpty(a))return-1/0;var d={computed:-1/0,value:-1/0};return y(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g>=d.computed&&(d={value:a,computed:g})}),d.value},x.min=function(a,b,c){if(!b&&x.isArray(a)&&a[0]===+a[0]&&65535>a.length)return Math.min.apply(Math,a);if(!b&&x.isEmpty(a))return 1/0;var d={computed:1/0,value:1/0};return y(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;d.computed>g&&(d={value:a,computed:g})}),d.value},x.shuffle=function(a){var b,c=0,d=[];return y(a,function(a){b=x.random(c++),d[c-1]=d[b],d[b]=a}),d};var B=function(a){return x.isFunction(a)?a:function(b){return b[a]}};x.sortBy=function(a,b,c){var d=B(b);return x.pluck(x.map(a,function(a,b,e){return{value:a,index:b,criteria:d.call(c,a,b,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||void 0===c)return 1;if(d>c||void 0===d)return-1}return a.index<b.index?-1:1}),"value")};var C=function(a,b,c,d){var e={},f=B(b||x.identity);return y(a,function(b,g){var h=f.call(c,b,g,a);d(e,h,b)}),e};x.groupBy=function(a,b,c){return C(a,b,c,function(a,b,c){(x.has(a,b)?a[b]:a[b]=[]).push(c)})},x.countBy=function(a,b,c){return C(a,b,c,function(a,b){x.has(a,b)||(a[b]=0),a[b]++})},x.sortedIndex=function(a,b,c,d){c=null==c?x.identity:B(c);for(var e=c.call(d,b),f=0,g=a.length;g>f;){var h=f+g>>>1;e>c.call(d,a[h])?f=h+1:g=h}return f},x.toArray=function(a){return a?x.isArray(a)?h.call(a):a.length===+a.length?x.map(a,x.identity):x.values(a):[]},x.size=function(a){return null==a?0:a.length===+a.length?a.length:x.keys(a).length},x.first=x.head=x.take=function(a,b,c){return null==a?void 0:null==b||c?a[0]:h.call(a,0,b)},x.initial=function(a,b,c){return h.call(a,0,a.length-(null==b||c?1:b))},x.last=function(a,b,c){return null==a?void 0:null==b||c?a[a.length-1]:h.call(a,Math.max(a.length-b,0))},x.rest=x.tail=x.drop=function(a,b,c){return h.call(a,null==b||c?1:b)},x.compact=function(a){return x.filter(a,x.identity)};var D=function(a,b,c){return y(a,function(a){x.isArray(a)?b?g.apply(c,a):D(a,b,c):c.push(a)}),c};x.flatten=function(a,b){return D(a,b,[])},x.without=function(a){return x.difference(a,h.call(arguments,1))},x.uniq=x.unique=function(a,b,c,d){x.isFunction(b)&&(d=c,c=b,b=!1);var e=c?x.map(a,c,d):a,f=[],g=[];return y(e,function(c,d){(b?d&&g[g.length-1]===c:x.contains(g,c))||(g.push(c),f.push(a[d]))}),f},x.union=function(){return x.uniq(i.apply(d,arguments))},x.intersection=function(a){var b=h.call(arguments,1);return x.filter(x.uniq(a),function(a){return x.every(b,function(b){return x.indexOf(b,a)>=0})})},x.difference=function(a){var b=i.apply(d,h.call(arguments,1));return x.filter(a,function(a){return!x.contains(b,a)})},x.zip=function(){for(var a=h.call(arguments),b=x.max(x.pluck(a,"length")),c=Array(b),d=0;b>d;d++)c[d]=x.pluck(a,""+d);return c},x.object=function(a,b){if(null==a)return{};for(var c={},d=0,e=a.length;e>d;d++)b?c[a[d]]=b[d]:c[a[d][0]]=a[d][1];return c},x.indexOf=function(a,b,c){if(null==a)return-1;var d=0,e=a.length;if(c){if("number"!=typeof c)return d=x.sortedIndex(a,b),a[d]===b?d:-1;d=0>c?Math.max(0,e+c):c}if(s&&a.indexOf===s)return a.indexOf(b,c);for(;e>d;d++)if(a[d]===b)return d;return-1},x.lastIndexOf=function(a,b,c){if(null==a)return-1;var d=null!=c;if(t&&a.lastIndexOf===t)return d?a.lastIndexOf(b,c):a.lastIndexOf(b);for(var e=d?c:a.length;e--;)if(a[e]===b)return e;return-1},x.range=function(a,b,c){1>=arguments.length&&(b=a||0,a=0),c=arguments[2]||1;for(var d=Math.max(Math.ceil((b-a)/c),0),e=0,f=Array(d);d>e;)f[e++]=a,a+=c;return f},x.bind=function(a,b){if(a.bind===w&&w)return w.apply(a,h.call(arguments,1));var c=h.call(arguments,2);return function(){return a.apply(b,c.concat(h.call(arguments)))}},x.partial=function(a){var b=h.call(arguments,1);return function(){return a.apply(this,b.concat(h.call(arguments)))}},x.bindAll=function(a){var b=h.call(arguments,1);return 0===b.length&&(b=x.functions(a)),y(b,function(b){a[b]=x.bind(a[b],a)}),a},x.memoize=function(a,b){var c={};return b||(b=x.identity),function(){var d=b.apply(this,arguments);return x.has(c,d)?c[d]:c[d]=a.apply(this,arguments)}},x.delay=function(a,b){var c=h.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)},x.defer=function(a){return x.delay.apply(x,[a,1].concat(h.call(arguments,1)))},x.throttle=function(a,b){var c,d,e,f,g=0,h=function(){g=new Date,e=null,f=a.apply(c,d)};return function(){var i=new Date,j=b-(i-g);return c=this,d=arguments,0>=j?(clearTimeout(e),e=null,g=i,f=a.apply(c,d)):e||(e=setTimeout(h,j)),f}},x.debounce=function(a,b,c){var d,e;return function(){var f=this,g=arguments,h=function(){d=null,c||(e=a.apply(f,g))},i=c&&!d;return clearTimeout(d),d=setTimeout(h,b),i&&(e=a.apply(f,g)),e}},x.once=function(a){var b,c=!1;return function(){return c?b:(c=!0,b=a.apply(this,arguments),a=null,b)}},x.wrap=function(a,b){return function(){var c=[a];return g.apply(c,arguments),b.apply(this,c)}},x.compose=function(){var a=arguments;return function(){for(var b=arguments,c=a.length-1;c>=0;c--)b=[a[c].apply(this,b)];return b[0]}},x.after=function(a,b){return 0>=a?b():function(){return 1>--a?b.apply(this,arguments):void 0}},x.keys=v||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[];for(var c in a)x.has(a,c)&&(b[b.length]=c);return b},x.values=function(a){var b=[];for(var c in a)x.has(a,c)&&b.push(a[c]);return b},x.pairs=function(a){var b=[];for(var c in a)x.has(a,c)&&b.push([c,a[c]]);return b},x.invert=function(a){var b={};for(var c in a)x.has(a,c)&&(b[a[c]]=c);return b},x.functions=x.methods=function(a){var b=[];for(var c in a)x.isFunction(a[c])&&b.push(c);return b.sort()},x.extend=function(a){return y(h.call(arguments,1),function(b){if(b)for(var c in b)a[c]=b[c]}),a},x.pick=function(a){var b={},c=i.apply(d,h.call(arguments,1));return y(c,function(c){c in a&&(b[c]=a[c])}),b},x.omit=function(a){var b={},c=i.apply(d,h.call(arguments,1));for(var e in a)x.contains(c,e)||(b[e]=a[e]);return b},x.defaults=function(a){return y(h.call(arguments,1),function(b){if(b)for(var c in b)null==a[c]&&(a[c]=b[c])}),a},x.clone=function(a){return x.isObject(a)?x.isArray(a)?a.slice():x.extend({},a):a},x.tap=function(a,b){return b(a),a};var E=function(a,b,c,d){if(a===b)return 0!==a||1/a==1/b;if(null==a||null==b)return a===b;a instanceof x&&(a=a._wrapped),b instanceof x&&(b=b._wrapped);var e=j.call(a);if(e!=j.call(b))return!1;switch(e){case"[object String]":return a==b+"";case"[object Number]":return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if("object"!=typeof a||"object"!=typeof b)return!1;for(var f=c.length;f--;)if(c[f]==a)return d[f]==b;c.push(a),d.push(b);var g=0,h=!0;if("[object Array]"==e){if(g=a.length,h=g==b.length)for(;g--&&(h=E(a[g],b[g],c,d)););}else{var i=a.constructor,k=b.constructor;if(i!==k&&!(x.isFunction(i)&&i instanceof i&&x.isFunction(k)&&k instanceof k))return!1;for(var l in a)if(x.has(a,l)&&(g++,!(h=x.has(b,l)&&E(a[l],b[l],c,d))))break;if(h){for(l in b)if(x.has(b,l)&&!g--)break;h=!g}}return c.pop(),d.pop(),h};x.isEqual=function(a,b){return E(a,b,[],[])},x.isEmpty=function(a){if(null==a)return!0;if(x.isArray(a)||x.isString(a))return 0===a.length;for(var b in a)if(x.has(a,b))return!1;return!0},x.isElement=function(a){return!(!a||1!==a.nodeType)},x.isArray=u||function(a){return"[object Array]"==j.call(a)},x.isObject=function(a){return a===Object(a)},y(["Arguments","Function","String","Number","Date","RegExp"],function(a){x["is"+a]=function(b){return j.call(b)=="[object "+a+"]"}}),x.isArguments(arguments)||(x.isArguments=function(a){return!(!a||!x.has(a,"callee"))}),"function"!=typeof/./&&(x.isFunction=function(a){return"function"==typeof a}),x.isFinite=function(a){return isFinite(a)&&!isNaN(parseFloat(a))},x.isNaN=function(a){return x.isNumber(a)&&a!=+a},x.isBoolean=function(a){return a===!0||a===!1||"[object Boolean]"==j.call(a)},x.isNull=function(a){return null===a},x.isUndefined=function(a){return void 0===a},x.has=function(a,b){return k.call(a,b)},x.noConflict=function(){return a._=b,this},x.identity=function(a){return a},x.times=function(a,b,c){for(var d=Array(a),e=0;a>e;e++)d[e]=b.call(c,e);return d},x.random=function(a,b){return null==b&&(b=a,a=0),a+Math.floor(Math.random()*(b-a+1))};var F={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};F.unescape=x.invert(F.escape);var G={escape:RegExp("["+x.keys(F.escape).join("")+"]","g"),unescape:RegExp("("+x.keys(F.unescape).join("|")+")","g")};x.each(["escape","unescape"],function(a){x[a]=function(b){return null==b?"":(""+b).replace(G[a],function(b){return F[a][b]})}}),x.result=function(a,b){if(null==a)return null;var c=a[b];return x.isFunction(c)?c.call(a):c},x.mixin=function(a){y(x.functions(a),function(b){var c=x[b]=a[b];x.prototype[b]=function(){var a=[this._wrapped];return g.apply(a,arguments),L.call(this,c.apply(x,a))}})};var H=0;x.uniqueId=function(a){var b=++H+"";return a?a+b:b},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var I=/(.)^/,J={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},K=/\\|'|\r|\n|\t|\u2028|\u2029/g;x.template=function(a,b,c){var d;c=x.defaults({},c,x.templateSettings);var e=RegExp([(c.escape||I).source,(c.interpolate||I).source,(c.evaluate||I).source].join("|")+"|$","g"),f=0,g="__p+='";a.replace(e,function(b,c,d,e,h){return g+=a.slice(f,h).replace(K,function(a){return"\\"+J[a]}),c&&(g+="'+\n((__t=("+c+"))==null?'':_.escape(__t))+\n'"),d&&(g+="'+\n((__t=("+d+"))==null?'':__t)+\n'"),e&&(g+="';\n"+e+"\n__p+='"),f=h+b.length,b}),g+="';\n",c.variable||(g="with(obj||{}){\n"+g+"}\n"),g="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+g+"return __p;\n";try{d=Function(c.variable||"obj","_",g)}catch(h){throw h.source=g,h}if(b)return d(b,x);var i=function(a){return d.call(this,a,x)};return i.source="function("+(c.variable||"obj")+"){\n"+g+"}",i},x.chain=function(a){return x(a).chain()};var L=function(a){return this._chain?x(a).chain():a};x.mixin(x),y(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=d[a];x.prototype[a]=function(){var c=this._wrapped;return b.apply(c,arguments),"shift"!=a&&"splice"!=a||0!==c.length||delete c[0],L.call(this,c)}}),y(["concat","join","slice"],function(a){var b=d[a];x.prototype[a]=function(){return L.call(this,b.apply(this._wrapped,arguments))}}),x.extend(x.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this),function(){var a,b=this,c=b.Backbone,d=[],e=d.push,f=d.slice,g=d.splice;a="undefined"!=typeof exports?exports:b.Backbone={},a.VERSION="1.0.0";var h=b._;h||"undefined"==typeof require||(h=require("underscore")),a.$=b.jQuery||b.Zepto||b.ender||b.$,a.noConflict=function(){return b.Backbone=c,this},a.emulateHTTP=!1,a.emulateJSON=!1;var i=a.Events={on:function(a,b,c){if(!k(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,b,c){if(!k(this,"once",a,[b,c])||!b)return this;var d=this,e=h.once(function(){d.off(a,e),b.apply(this,arguments)});return e._callback=b,this.on(a,e,c)},off:function(a,b,c){var d,e,f,g,i,j,l,m;if(!this._events||!k(this,"off",a,[b,c]))return this;if(!a&&!b&&!c)return this._events={},this;for(g=a?[a]:h.keys(this._events),i=0,j=g.length;j>i;i++)if(a=g[i],f=this._events[a]){if(this._events[a]=d=[],b||c)for(l=0,m=f.length;m>l;l++)e=f[l],(b&&b!==e.callback&&b!==e.callback._callback||c&&c!==e.context)&&d.push(e);d.length||delete this._events[a]}return this},trigger:function(a){if(!this._events)return this;var b=f.call(arguments,1);if(!k(this,"trigger",a,b))return this;var c=this._events[a],d=this._events.all;return c&&l(c,b),d&&l(d,arguments),this},stopListening:function(a,b,c){var d=this._listeners;if(!d)return this;var e=!b&&!c;"object"==typeof b&&(c=this),a&&((d={})[a._listenerId]=a);for(var f in d)d[f].off(b,c,this),e&&delete this._listeners[f];return this}},j=/\s+/,k=function(a,b,c,d){if(!c)return!0;if("object"==typeof c){for(var e in c)a[b].apply(a,[e,c[e]].concat(d));return!1}if(j.test(c)){for(var f=c.split(j),g=0,h=f.length;h>g;g++)a[b].apply(a,[f[g]].concat(d));return!1}return!0},l=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b)}},m={listenTo:"on",listenToOnce:"once"};h.each(m,function(a,b){i[b]=function(b,c,d){var e=this._listeners||(this._listeners={}),f=b._listenerId||(b._listenerId=h.uniqueId("l"));return e[f]=b,"object"==typeof c&&(d=this),b[a](c,d,this),this}}),i.bind=i.on,i.unbind=i.off,h.extend(a,i);var n=a.Model=function(a,b){var c,d=a||{};b||(b={}),this.cid=h.uniqueId("c"),this.attributes={},h.extend(this,h.pick(b,o)),b.parse&&(d=this.parse(d,b)||{}),(c=h.result(this,"defaults"))&&(d=h.defaults({},d,c)),this.set(d,b),this.changed={},this.initialize.apply(this,arguments)},o=["url","urlRoot","collection"];h.extend(n.prototype,i,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(){return h.clone(this.attributes)},sync:function(){return a.sync.apply(this,arguments)},get:function(a){return this.attributes[a]},escape:function(a){return h.escape(this.get(a))},has:function(a){return null!=this.get(a)},set:function(a,b,c){var d,e,f,g,i,j,k,l;if(null==a)return this;if("object"==typeof a?(e=a,c=b):(e={})[a]=b,c||(c={}),!this._validate(e,c))return!1;f=c.unset,i=c.silent,g=[],j=this._changing,this._changing=!0,j||(this._previousAttributes=h.clone(this.attributes),this.changed={}),l=this.attributes,k=this._previousAttributes,this.idAttribute in e&&(this.id=e[this.idAttribute]);for(d in e)b=e[d],h.isEqual(l[d],b)||g.push(d),h.isEqual(k[d],b)?delete this.changed[d]:this.changed[d]=b,f?delete l[d]:l[d]=b;if(!i){g.length&&(this._pending=!0);for(var m=0,n=g.length;n>m;m++)this.trigger("change:"+g[m],this,l[g[m]],c)}if(j)return this;if(!i)for(;this._pending;)this._pending=!1,this.trigger("change",this,c);return this._pending=!1,this._changing=!1,this},unset:function(a,b){return this.set(a,void 0,h.extend({},b,{unset:!0}))},clear:function(a){var b={};for(var c in this.attributes)b[c]=void 0;return this.set(b,h.extend({},a,{unset:!0}))},hasChanged:function(a){return null==a?!h.isEmpty(this.changed):h.has(this.changed,a)},changedAttributes:function(a){if(!a)return this.hasChanged()?h.clone(this.changed):!1;var b,c=!1,d=this._changing?this._previousAttributes:this.attributes;for(var e in a)h.isEqual(d[e],b=a[e])||((c||(c={}))[e]=b);return c},previous:function(a){return null!=a&&this._previousAttributes?this._previousAttributes[a]:null},previousAttributes:function(){return h.clone(this._previousAttributes)},fetch:function(a){a=a?h.clone(a):{},void 0===a.parse&&(a.parse=!0);var b=this,c=a.success;return a.success=function(d){return b.set(b.parse(d,a),a)?(c&&c(b,d,a),b.trigger("sync",b,d,a),void 0):!1},L(this,a),this.sync("read",this,a)},save:function(a,b,c){var d,e,f,g=this.attributes;if(null==a||"object"==typeof a?(d=a,c=b):(d={})[a]=b,!(!d||c&&c.wait||this.set(d,c)))return!1;if(c=h.extend({validate:!0},c),!this._validate(d,c))return!1;d&&c.wait&&(this.attributes=h.extend({},g,d)),void 0===c.parse&&(c.parse=!0);var i=this,j=c.success;return c.success=function(a){i.attributes=g;var b=i.parse(a,c);return c.wait&&(b=h.extend(d||{},b)),h.isObject(b)&&!i.set(b,c)?!1:(j&&j(i,a,c),i.trigger("sync",i,a,c),void 0)},L(this,c),e=this.isNew()?"create":c.patch?"patch":"update","patch"===e&&(c.attrs=d),f=this.sync(e,this,c),d&&c.wait&&(this.attributes=g),f},destroy:function(a){a=a?h.clone(a):{};var b=this,c=a.success,d=function(){b.trigger("destroy",b,b.collection,a)};if(a.success=function(e){(a.wait||b.isNew())&&d(),c&&c(b,e,a),b.isNew()||b.trigger("sync",b,e,a)},this.isNew())return a.success(),!1;L(this,a);var e=this.sync("delete",this,a);return a.wait||d(),e},url:function(){var a=h.result(this,"urlRoot")||h.result(this.collection,"url")||K();return this.isNew()?a:a+("/"===a.charAt(a.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(a){return a},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},isValid:function(a){return this._validate({},h.extend(a||{},{validate:!0}))},_validate:function(a,b){if(!b.validate||!this.validate)return!0;a=h.extend({},this.attributes,a);var c=this.validationError=this.validate(a,b)||null;return c?(this.trigger("invalid",this,c,h.extend(b||{},{validationError:c})),!1):!0}});var p=["keys","values","pairs","invert","pick","omit"];h.each(p,function(a){n.prototype[a]=function(){var b=f.call(arguments);return b.unshift(this.attributes),h[a].apply(h,b)}});var q=a.Collection=function(a,b){b||(b={}),b.url&&(this.url=b.url),b.model&&(this.model=b.model),void 0!==b.comparator&&(this.comparator=b.comparator),this._reset(),this.initialize.apply(this,arguments),a&&this.reset(a,h.extend({silent:!0},b))},r={add:!0,remove:!0,merge:!0},s={add:!0,merge:!1,remove:!1};h.extend(q.prototype,i,{model:n,initialize:function(){},toJSON:function(a){return this.map(function(b){return b.toJSON(a)})},sync:function(){return a.sync.apply(this,arguments)},add:function(a,b){return this.set(a,h.defaults(b||{},s))},remove:function(a,b){a=h.isArray(a)?a.slice():[a],b||(b={});var c,d,e,f;for(c=0,d=a.length;d>c;c++)f=this.get(a[c]),f&&(delete this._byId[f.id],delete this._byId[f.cid],e=this.indexOf(f),this.models.splice(e,1),this.length--,b.silent||(b.index=e,f.trigger("remove",f,this,b)),this._removeReference(f));return this},set:function(a,b){b=h.defaults(b||{},r),b.parse&&(a=this.parse(a,b)),h.isArray(a)||(a=a?[a]:[]);var c,d,f,i,j,k=b.at,l=this.comparator&&null==k&&b.sort!==!1,m=h.isString(this.comparator)?this.comparator:null,n=[],o=[],p={};for(c=0,d=a.length;d>c;c++)(f=this._prepareModel(a[c],b))&&((i=this.get(f))?(b.remove&&(p[i.cid]=!0),b.merge&&(i.set(f.attributes,b),l&&!j&&i.hasChanged(m)&&(j=!0))):b.add&&(n.push(f),f.on("all",this._onModelEvent,this),this._byId[f.cid]=f,null!=f.id&&(this._byId[f.id]=f)));if(b.remove){for(c=0,d=this.length;d>c;++c)p[(f=this.models[c]).cid]||o.push(f);o.length&&this.remove(o,b)}if(n.length&&(l&&(j=!0),this.length+=n.length,null!=k?g.apply(this.models,[k,0].concat(n)):e.apply(this.models,n)),j&&this.sort({silent:!0}),b.silent)return this;for(c=0,d=n.length;d>c;c++)(f=n[c]).trigger("add",f,this,b);return j&&this.trigger("sort",this,b),this},reset:function(a,b){b||(b={});for(var c=0,d=this.models.length;d>c;c++)this._removeReference(this.models[c]);return b.previousModels=this.models,this._reset(),this.add(a,h.extend({silent:!0},b)),b.silent||this.trigger("reset",this,b),this},push:function(a,b){return a=this._prepareModel(a,b),this.add(a,h.extend({at:this.length},b)),a},pop:function(a){var b=this.at(this.length-1);return this.remove(b,a),b},unshift:function(a,b){return a=this._prepareModel(a,b),this.add(a,h.extend({at:0},b)),a},shift:function(a){var b=this.at(0);return this.remove(b,a),b},slice:function(a,b){return this.models.slice(a,b)},get:function(a){return null==a?void 0:this._byId[null!=a.id?a.id:a.cid||a]},at:function(a){return this.models[a]},where:function(a,b){return h.isEmpty(a)?b?void 0:[]:this[b?"find":"filter"](function(b){for(var c in a)if(a[c]!==b.get(c))return!1;return!0})},findWhere:function(a){return this.where(a,!0)},sort:function(a){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return a||(a={}),h.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(h.bind(this.comparator,this)),a.silent||this.trigger("sort",this,a),this},sortedIndex:function(a,b,c){b||(b=this.comparator);var d=h.isFunction(b)?b:function(a){return a.get(b)};return h.sortedIndex(this.models,a,d,c)},pluck:function(a){return h.invoke(this.models,"get",a)},fetch:function(a){a=a?h.clone(a):{},void 0===a.parse&&(a.parse=!0);var b=a.success,c=this;return a.success=function(d){var e=a.reset?"reset":"set";c[e](d,a),b&&b(c,d,a),c.trigger("sync",c,d,a)},L(this,a),this.sync("read",this,a)},create:function(a,b){if(b=b?h.clone(b):{},!(a=this._prepareModel(a,b)))return!1;b.wait||this.add(a,b);var c=this,d=b.success;return b.success=function(e){b.wait&&c.add(a,b),d&&d(a,e,b)},a.save(null,b),a},parse:function(a){return a},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(a,b){if(a instanceof n)return a.collection||(a.collection=this),a;b||(b={}),b.collection=this;var c=new this.model(a,b);return c._validate(a,b)?c:(this.trigger("invalid",this,a,b),!1)},_removeReference:function(a){this===a.collection&&delete a.collection,a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,b,c,d){("add"!==a&&"remove"!==a||c===this)&&("destroy"===a&&this.remove(b,d),b&&a==="change:"+b.idAttribute&&(delete this._byId[b.previous(b.idAttribute)],null!=b.id&&(this._byId[b.id]=b)),this.trigger.apply(this,arguments))}});var t=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];h.each(t,function(a){q.prototype[a]=function(){var b=f.call(arguments);return b.unshift(this.models),h[a].apply(h,b)}});var u=["groupBy","countBy","sortBy"];h.each(u,function(a){q.prototype[a]=function(b,c){var d=h.isFunction(b)?b:function(a){return a.get(b)};return h[a](this.models,d,c)}});var v=a.View=function(a){this.cid=h.uniqueId("view"),this._configure(a||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},w=/^(\S+)\s*(.*)$/,x=["model","collection","el","id","attributes","className","tagName","events"];h.extend(v.prototype,i,{tagName:"div",$:function(a){return this.$el.find(a)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(b,c){return this.$el&&this.undelegateEvents(),this.$el=b instanceof a.$?b:a.$(b),this.el=this.$el[0],c!==!1&&this.delegateEvents(),this},delegateEvents:function(a){if(!a&&!(a=h.result(this,"events")))return this;this.undelegateEvents();for(var b in a){var c=a[b];if(h.isFunction(c)||(c=this[a[b]]),c){var d=b.match(w),e=d[1],f=d[2];c=h.bind(c,this),e+=".delegateEvents"+this.cid,""===f?this.$el.on(e,c):this.$el.on(e,f,c)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_configure:function(a){this.options&&(a=h.extend({},h.result(this,"options"),a)),h.extend(this,h.pick(a,x)),this.options=a},_ensureElement:function(){if(this.el)this.setElement(h.result(this,"el"),!1);else{var b=h.extend({},h.result(this,"attributes"));this.id&&(b.id=h.result(this,"id")),this.className&&(b["class"]=h.result(this,"className"));var c=a.$("<"+h.result(this,"tagName")+">").attr(b);this.setElement(c,!1)}}}),a.sync=function(b,c,d){var e=y[b];h.defaults(d||(d={}),{emulateHTTP:a.emulateHTTP,emulateJSON:a.emulateJSON});var f={type:e,dataType:"json"};if(d.url||(f.url=h.result(c,"url")||K()),null!=d.data||!c||"create"!==b&&"update"!==b&&"patch"!==b||(f.contentType="application/json",f.data=JSON.stringify(d.attrs||c.toJSON(d))),d.emulateJSON&&(f.contentType="application/x-www-form-urlencoded",f.data=f.data?{model:f.data}:{}),d.emulateHTTP&&("PUT"===e||"DELETE"===e||"PATCH"===e)){f.type="POST",d.emulateJSON&&(f.data._method=e);var g=d.beforeSend;d.beforeSend=function(a){return a.setRequestHeader("X-HTTP-Method-Override",e),g?g.apply(this,arguments):void 0}}"GET"===f.type||d.emulateJSON||(f.processData=!1),"PATCH"!==f.type||!window.ActiveXObject||window.external&&window.external.msActiveXFilteringEnabled||(f.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var i=d.xhr=a.ajax(h.extend(f,d));return c.trigger("request",c,i,d),i};var y={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};a.ajax=function(){return a.$.ajax.apply(a.$,arguments)};var z=a.Router=function(a){a||(a={}),a.routes&&(this.routes=a.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},A=/\((.*?)\)/g,B=/(\(\?)?:\w+/g,C=/\*\w+/g,D=/[\-{}\[\]+?.,\\\^$|#\s]/g;h.extend(z.prototype,i,{initialize:function(){},route:function(b,c,d){h.isRegExp(b)||(b=this._routeToRegExp(b)),h.isFunction(c)&&(d=c,c=""),d||(d=this[c]);var e=this;return a.history.route(b,function(f){var g=e._extractParameters(b,f);d&&d.apply(e,g),e.trigger.apply(e,["route:"+c].concat(g)),e.trigger("route",c,g),a.history.trigger("route",e,c,g)}),this},navigate:function(b,c){return a.history.navigate(b,c),this},_bindRoutes:function(){if(this.routes){this.routes=h.result(this,"routes");for(var a,b=h.keys(this.routes);null!=(a=b.pop());)this.route(a,this.routes[a])}},_routeToRegExp:function(a){return a=a.replace(D,"\\$&").replace(A,"(?:$1)?").replace(B,function(a,b){return b?a:"([^/]+)"}).replace(C,"(.*?)"),new RegExp("^"+a+"$")},_extractParameters:function(a,b){var c=a.exec(b).slice(1);return h.map(c,function(a){return a?decodeURIComponent(a):null})}});var E=a.History=function(){this.handlers=[],h.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},F=/^[#\/]|\s+$/g,G=/^\/+|\/+$/g,H=/msie [\w.]+/,I=/\/$/;E.started=!1,h.extend(E.prototype,i,{interval:50,getHash:function(a){var b=(a||this).location.href.match(/#(.*)$/);return b?b[1]:""},getFragment:function(a,b){if(null==a)if(this._hasPushState||!this._wantsHashChange||b){a=this.location.pathname;var c=this.root.replace(I,"");a.indexOf(c)||(a=a.substr(c.length))}else a=this.getHash();return a.replace(F,"")},start:function(b){if(E.started)throw new Error("Backbone.history has already been started");E.started=!0,this.options=h.extend({},{root:"/"},this.options,b),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var c=this.getFragment(),d=document.documentMode,e=H.exec(navigator.userAgent.toLowerCase())&&(!d||7>=d);this.root=("/"+this.root+"/").replace(G,"/"),e&&this._wantsHashChange&&(this.iframe=a.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(c)),this._hasPushState?a.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!e?a.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=c;var f=this.location,g=f.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!g?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&g&&f.hash&&(this.fragment=this.getHash().replace(F,""),this.history.replaceState({},document.title,this.root+this.fragment+f.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){a.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),E.started=!1},route:function(a,b){this.handlers.unshift({route:a,callback:b})},checkUrl:function(){var a=this.getFragment();return a===this.fragment&&this.iframe&&(a=this.getFragment(this.getHash(this.iframe))),a===this.fragment?!1:(this.iframe&&this.navigate(a),this.loadUrl()||this.loadUrl(this.getHash()),void 0)},loadUrl:function(a){var b=this.fragment=this.getFragment(a),c=h.any(this.handlers,function(a){return a.route.test(b)?(a.callback(b),!0):void 0});return c},navigate:function(a,b){if(!E.started)return!1;if(b&&b!==!0||(b={trigger:b}),a=this.getFragment(a||""),this.fragment!==a){this.fragment=a;var c=this.root+a;if(this._hasPushState)this.history[b.replace?"replaceState":"pushState"]({},document.title,c);else{if(!this._wantsHashChange)return this.location.assign(c);this._updateHash(this.location,a,b.replace),this.iframe&&a!==this.getFragment(this.getHash(this.iframe))&&(b.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,a,b.replace))}b.trigger&&this.loadUrl(a)}},_updateHash:function(a,b,c){if(c){var d=a.href.replace(/(javascript:|#).*$/,"");a.replace(d+"#"+b)}else a.hash="#"+b}}),a.history=new E;var J=function(a,b){var c,d=this;c=a&&h.has(a,"constructor")?a.constructor:function(){return d.apply(this,arguments)},h.extend(c,d,b);var e=function(){this.constructor=c};return e.prototype=d.prototype,c.prototype=new e,a&&h.extend(c.prototype,a),c.__super__=d.prototype,c};n.extend=q.extend=z.extend=v.extend=E.extend=J;var K=function(){throw new Error('A "url" property or function must be specified')
},L=function(a,b){var c=b.error;b.error=function(d){c&&c(a,d,b),a.trigger("error",a,d,b)}}}.call(this),function(){function a(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function b(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}var c=this._,d=this.Backbone;d.LocalStorage=window.Store=function(a){this.name=a;var b=this.localStorage().getItem(this.name);this.records=b&&b.split(",")||[]},c.extend(d.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(a){return a.id||(a.id=b(),a.set(a.idAttribute,a.id)),this.localStorage().setItem(this.name+"-"+a.id,JSON.stringify(a)),this.records.push(a.id.toString()),this.save(),a},update:function(a){return this.localStorage().setItem(this.name+"-"+a.id,JSON.stringify(a)),c.include(this.records,a.id.toString())||this.records.push(a.id.toString()),this.save(),a},find:function(a){return JSON.parse(this.localStorage().getItem(this.name+"-"+a.id))},findAll:function(){return c(this.records).chain().map(function(a){return JSON.parse(this.localStorage().getItem(this.name+"-"+a))},this).compact().value()},destroy:function(a){return this.localStorage().removeItem(this.name+"-"+a.id),this.records=c.reject(this.records,function(b){return b==a.id.toString()}),this.save(),a},localStorage:function(){return localStorage}}),d.LocalStorage.sync=window.Store.sync=d.localSync=function(a,b,c,d){var e=b.localStorage||b.collection.localStorage;"function"==typeof c&&(c={success:c,error:d});var f;switch(a){case"read":f=void 0!=b.id?e.find(b):e.findAll();break;case"create":f=e.create(b);break;case"update":f=e.update(b);break;case"delete":f=e.destroy(b)}f?c.success(f):c.error("Record not found")},d.ajaxSync=d.sync,d.getSyncMethod=function(a){return a.localStorage||a.collection&&a.collection.localStorage?d.localSync:d.ajaxSync},d.sync=function(a,b,c,e){return d.getSyncMethod(b).apply(this,[a,b,c,e])}}(),function(){function a(a,b,c){return a.addEventListener?a.addEventListener(b,c,!1):(a.attachEvent("on"+b,c),void 0)}function b(a){return"keypress"==a.type?String.fromCharCode(a.which):t[a.which]?t[a.which]:u[a.which]?u[a.which]:String.fromCharCode(a.which).toLowerCase()}function c(a){var b=a.target||a.srcElement,c=b.tagName;return(" "+b.className+" ").indexOf(" mousetrap ")>-1?!1:"INPUT"==c||"SELECT"==c||"TEXTAREA"==c||b.contentEditable&&"true"==b.contentEditable}function d(a,b){return a.sort().join(",")===b.sort().join(",")}function e(a){a=a||{};var b,c=!1;for(b in z)a[b]?c=!0:z[b]=0;c||(B=!1)}function f(a,b,c,e,f){var g,h,i=[],j=c.type;if(!x[a])return[];for("keyup"==j&&k(a)&&(b=[a]),g=0;g<x[a].length;++g)h=x[a][g],h.seq&&z[h.seq]!=h.level||j==h.action&&("keypress"==j&&!c.metaKey&&!c.ctrlKey||d(b,h.modifiers))&&(e&&h.combo==f&&x[a].splice(g,1),i.push(h));return i}function g(a){var b=[];return a.shiftKey&&b.push("shift"),a.altKey&&b.push("alt"),a.ctrlKey&&b.push("ctrl"),a.metaKey&&b.push("meta"),b}function h(a,b){a(b)===!1&&(b.preventDefault&&b.preventDefault(),b.stopPropagation&&b.stopPropagation(),b.returnValue=!1,b.cancelBubble=!0)}function i(a,b){if(!c(b)){var d,i=f(a,g(b),b),j={},l=!1;for(d=0;d<i.length;++d)i[d].seq?(l=!0,j[i[d].seq]=1,h(i[d].callback,b)):l||B||h(i[d].callback,b);b.type!=B||k(a)||e(j)}}function j(a){a.which="number"==typeof a.which?a.which:a.keyCode;var c=b(a);if(c)return"keyup"==a.type&&A==c?(A=!1,void 0):(i(c,a),void 0)}function k(a){return"shift"==a||"ctrl"==a||"alt"==a||"meta"==a}function l(){clearTimeout(s),s=setTimeout(e,1e3)}function m(){if(!r){r={};for(var a in t)a>95&&112>a||t.hasOwnProperty(a)&&(r[t[a]]=a)}return r}function n(a,b,c){return c||(c=m()[a]?"keydown":"keypress"),"keypress"==c&&b.length&&(c="keydown"),c}function o(a,c,d,f){z[a]=0,f||(f=n(c[0],[]));var g,i=function(){B=f,++z[a],l()},j=function(a){h(d,a),"keyup"!==f&&(A=b(a)),setTimeout(e,10)};for(g=0;g<c.length;++g)p(c[g],g<c.length-1?i:j,f,a,g)}function p(a,b,c,d,e){a=a.replace(/\s+/g," ");var g,h,i,j=a.split(" "),l=[];if(j.length>1)return o(a,j,b,c);for(i="+"===a?["+"]:a.split("+"),g=0;g<i.length;++g)h=i[g],w[h]&&(h=w[h]),c&&"keypress"!=c&&v[h]&&(h=v[h],l.push("shift")),k(h)&&l.push(h);c=n(h,l,c),x[h]||(x[h]=[]),f(h,l,{type:c},!d,a),x[h][d?"unshift":"push"]({callback:b,modifiers:l,action:c,seq:d,level:e,combo:a})}function q(a,b,c){for(var d=0;d<a.length;++d)p(a[d],b,c)}for(var r,s,t={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},u={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},v={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},w={option:"alt",command:"meta","return":"enter",escape:"esc"},x={},y={},z={},A=!1,B=!1,C=1;20>C;++C)t[111+C]="f"+C;for(C=0;9>=C;++C)t[C+96]=C;a(document,"keypress",j),a(document,"keydown",j),a(document,"keyup",j);var D={bind:function(a,b,c){return q(a instanceof Array?a:[a],b,c),y[a+":"+c]=b,this},unbind:function(a,b){return y[a+":"+b]&&(delete y[a+":"+b],this.bind(a,function(){},b)),this},trigger:function(a,b){return y[a+":"+b](),this},reset:function(){return x={},y={},this}};window.Mousetrap=D,"function"==typeof define&&define.amd&&define("mousetrap",function(){return D})}(),function(a,b,c){function d(a,b,c){for(var d=[],e=0;e<a.length;e++){var f=tinycolor(a[e]),g=f.toHsl().l<.5?"sp-thumb-el sp-thumb-dark":"sp-thumb-el sp-thumb-light";g+=tinycolor.equals(b,a[e])?" sp-thumb-active":"";var h=q?"background-color:"+f.toRgbString():"filter:"+f.toFilter();d.push('<span title="'+f.toRgbString()+'" data-color="'+f.toRgbString()+'" class="'+g+'"><span class="sp-thumb-inner" style="'+h+';" /></span>')}return"<div class='sp-cf "+c+"'>"+d.join("")+"</div>"}function e(){for(var a=0;a<o.length;a++)o[a]&&o[a].hide()}function f(a,c){var d=b.extend({},n,a);return d.callbacks={move:k(d.move,c),change:k(d.change,c),show:k(d.show,c),hide:k(d.hide,c),beforeShow:k(d.beforeShow,c)},d}function g(g,i){function k(){qb.toggleClass("sp-flat",R),qb.toggleClass("sp-input-disabled",!Q.showInput),qb.toggleClass("sp-alpha-enabled",Q.showAlpha),qb.toggleClass("sp-buttons-disabled",!Q.showButtons||R),qb.toggleClass("sp-palette-disabled",!Q.showPalette),qb.toggleClass("sp-palette-only",Q.showPaletteOnly),qb.toggleClass("sp-initial-disabled",!Q.showInitial),qb.addClass(Q.className),L()}function n(){function c(a){return a.data&&a.data.ignore?(E(b(this).data("color")),H()):(E(b(this).data("color")),K(!0),H(),C()),!1}if(p&&qb.find("*:not(input)").attr("unselectable","on"),k(),Eb&&ob.after(Fb).hide(),R)ob.after(qb).hide();else{var d="parent"===Q.appendTo?ob.parent():b(Q.appendTo);1!==d.length&&(d=b("body")),d.append(qb)}if(T&&a.localStorage){try{var e=a.localStorage[T].split(",#");e.length>1&&(delete a.localStorage[T],b.each(e,function(a,b){t(b)}))}catch(f){}try{kb=a.localStorage[T].split(";")}catch(f){}}Gb.bind("click.spectrum touchstart.spectrum",function(a){pb||A(),a.stopPropagation(),b(a.target).is("input")||a.preventDefault()}),(ob.is(":disabled")||Q.disabled===!0)&&P(),qb.click(j),yb.change(z),yb.bind("paste",function(){setTimeout(z,1)}),yb.keydown(function(a){13==a.keyCode&&z()}),Bb.text(Q.cancelText),Bb.bind("click.spectrum",function(a){a.stopPropagation(),a.preventDefault(),C("cancel")}),Cb.text(Q.chooseText),Cb.bind("click.spectrum",function(a){a.stopPropagation(),a.preventDefault(),G()&&(K(!0),C())}),l(wb,function(a,b,c){hb=a/bb,c.shiftKey&&(hb=Math.round(10*hb)/10),H()}),l(tb,function(a,b){eb=parseFloat(b/_),H()},x,y),l(rb,function(a,b){fb=parseFloat(a/Y),gb=parseFloat((Z-b)/Z),H()},x,y),Ib?(E(Ib),I(),Lb=Kb||tinycolor(Ib).format,t(Ib)):I(),R&&B();var g=p?"mousedown.spectrum":"click.spectrum touchstart.spectrum";zb.delegate(".sp-thumb-el",g,c),Ab.delegate(".sp-thumb-el:nth-child(1)",g,{ignore:!0},c)}function t(c){if(S){var d=tinycolor(c).toRgbString();if(-1===b.inArray(d,kb))for(kb.push(d);kb.length>lb;)kb.shift();if(T&&a.localStorage)try{a.localStorage[T]=kb.join(";")}catch(e){}}}function u(){var a,b=[],c=kb,d={};if(Q.showPalette){for(var e=0;e<jb.length;e++)for(var f=0;f<jb[e].length;f++)a=tinycolor(jb[e][f]).toRgbString(),d[a]=!0;for(e=0;e<c.length;e++)a=tinycolor(c[e]).toRgbString(),d.hasOwnProperty(a)||(b.push(c[e]),d[a]=!0)}return b.reverse().slice(0,Q.maxSelectionSize)}function v(){var a=F(),c=b.map(jb,function(b,c){return d(b,a,"sp-palette-row sp-palette-row-"+c)});kb&&c.push(d(u(),a,"sp-palette-row sp-palette-row-selection")),zb.html(c.join(""))}function w(){if(Q.showInitial){var a=Jb,b=F();Ab.html(d([a,b],b,"sp-palette-row-initial"))}}function x(){(0>=Z||0>=Y||0>=_)&&L(),qb.addClass(mb)}function y(){qb.removeClass(mb)}function z(){var a=tinycolor(yb.val());a.ok?E(a):yb.addClass("sp-validation-error")}function A(){X?C():B()}function B(){var c=b.Event("beforeShow.spectrum");return X?(L(),void 0):(ob.trigger(c,[F()]),V.beforeShow(F())===!1||c.isDefaultPrevented()||(e(),X=!0,b(nb).bind("click.spectrum",C),b(a).bind("resize.spectrum",W),Fb.addClass("sp-active"),qb.removeClass("sp-hidden"),Q.showPalette&&v(),L(),I(),Jb=F(),w(),V.show(Jb),ob.trigger("show.spectrum",[Jb])),void 0)}function C(c){if((!c||"click"!=c.type||2!=c.button)&&X&&!R){X=!1,b(nb).unbind("click.spectrum",C),b(a).unbind("resize.spectrum",W),Fb.removeClass("sp-active"),qb.addClass("sp-hidden");var d=!tinycolor.equals(F(),Jb);d&&(Mb&&"cancel"!==c?K(!0):D()),V.hide(F()),ob.trigger("hide.spectrum",[F()])}}function D(){E(Jb,!0)}function E(a,b){if(!tinycolor.equals(a,F())){var c=tinycolor(a),d=c.toHsv();eb=d.h,fb=d.s,gb=d.v,hb=d.a,I(),c.ok&&!b&&(Lb=Kb||c.format)}}function F(a){return a=a||{},tinycolor.fromRatio({h:eb,s:fb,v:gb,a:Math.round(100*hb)/100},{format:a.format||Lb})}function G(){return!yb.hasClass("sp-validation-error")}function H(){I(),V.move(F()),ob.trigger("move.spectrum",[F()])}function I(){yb.removeClass("sp-validation-error"),J();var a=tinycolor.fromRatio({h:eb,s:1,v:1});rb.css("background-color",a.toHexString());var b=Lb;1>hb&&("hex"===b||"hex3"===b||"hex6"===b||"name"===b)&&(b="rgb");var c=F({format:b}),d=c.toHexString(),e=c.toRgbString();if(q||1===c.alpha?Hb.css("background-color",e):(Hb.css("background-color","transparent"),Hb.css("filter",c.toFilter())),Q.showAlpha){var f=c.toRgb();f.a=0;var g=tinycolor(f).toRgbString(),h="linear-gradient(left, "+g+", "+d+")";p?vb.css("filter",tinycolor(g).toFilter({gradientType:1},d)):(vb.css("background","-webkit-"+h),vb.css("background","-moz-"+h),vb.css("background","-ms-"+h),vb.css("background",h))}Q.showInput&&yb.val(c.toString(b)),Q.showPalette&&v(),w()}function J(){var a=fb,b=gb,c=a*Y,d=Z-b*Z;c=Math.max(-$,Math.min(Y-$,c-$)),d=Math.max(-$,Math.min(Z-$,d-$)),sb.css({top:d,left:c});var e=hb*bb;xb.css({left:e-cb/2});var f=eb*_;ub.css({top:f-db})}function K(a){var b=F();Db&&ob.val(b.toString(Lb)).change();var c=!tinycolor.equals(b,Jb);Jb=b,t(b),a&&c&&(V.change(b),ob.trigger("change.spectrum",[b]))}function L(){Y=rb.width(),Z=rb.height(),$=sb.height(),ab=tb.width(),_=tb.height(),db=ub.height(),bb=wb.width(),cb=xb.width(),R||(qb.css("position","absolute"),qb.offset(h(qb,Gb))),J()}function M(){ob.show(),Gb.unbind("click.spectrum touchstart.spectrum"),qb.remove(),Fb.remove(),o[Nb.id]=null}function N(a,d){return a===c?b.extend({},Q):d===c?Q[a]:(Q[a]=d,k(),void 0)}function O(){pb=!1,ob.attr("disabled",!1),Gb.removeClass("sp-disabled")}function P(){C(),pb=!0,ob.attr("disabled",!0),Gb.addClass("sp-disabled")}var Q=f(i,g),R=Q.flat,S=Q.showSelectionPalette,T=Q.localStorageKey,U=Q.theme,V=Q.callbacks,W=m(L,10),X=!1,Y=0,Z=0,$=0,_=0,ab=0,bb=0,cb=0,db=0,eb=0,fb=0,gb=0,hb=1,ib=Q.palette.slice(0),jb=b.isArray(ib[0])?ib:[ib],kb=Q.selectionPalette.slice(0),lb=Q.maxSelectionSize,mb="sp-dragging",nb=g.ownerDocument,ob=(nb.body,b(g)),pb=!1,qb=b(s,nb).addClass(U),rb=qb.find(".sp-color"),sb=qb.find(".sp-dragger"),tb=qb.find(".sp-hue"),ub=qb.find(".sp-slider"),vb=qb.find(".sp-alpha-inner"),wb=qb.find(".sp-alpha"),xb=qb.find(".sp-alpha-handle"),yb=qb.find(".sp-input"),zb=qb.find(".sp-palette"),Ab=qb.find(".sp-initial"),Bb=qb.find(".sp-cancel"),Cb=qb.find(".sp-choose"),Db=ob.is("input"),Eb=Db&&!R,Fb=Eb?b(r).addClass(U).addClass(Q.className):b([]),Gb=Eb?Fb:ob,Hb=Fb.find(".sp-preview-inner"),Ib=Q.color||Db&&ob.val(),Jb=!1,Kb=Q.preferredFormat,Lb=Kb,Mb=!Q.showButtons||Q.clickoutFiresChange;n();var Nb={show:B,hide:C,toggle:A,reflow:L,option:N,enable:O,disable:P,set:function(a){E(a),K()},get:F,destroy:M,container:qb};return Nb.id=o.push(Nb)-1,Nb}function h(a,c){var d=0,e=a.outerWidth(),f=a.outerHeight(),g=c.outerHeight(),h=a[0].ownerDocument,i=h.documentElement,j=i.clientWidth+b(h).scrollLeft(),k=i.clientHeight+b(h).scrollTop(),l=c.offset();return l.top+=g,l.left-=Math.min(l.left,l.left+e>j&&j>e?Math.abs(l.left+e-j):0),l.top-=Math.min(l.top,l.top+f>k&&k>f?Math.abs(f+g-d):d),l}function i(){}function j(a){a.stopPropagation()}function k(a,b){var c=Array.prototype.slice,d=c.call(arguments,2);return function(){return a.apply(b,d.concat(c.call(arguments)))}}function l(c,d,e,f){function g(a){a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault(),a.returnValue=!1}function h(a){if(l){if(p&&document.documentMode<9&&!a.button)return j();var b=a.originalEvent.touches,e=b?b[0].pageX:a.pageX,f=b?b[0].pageY:a.pageY,h=Math.max(0,Math.min(e-m.left,o)),i=Math.max(0,Math.min(f-m.top,n));q&&g(a),d.apply(c,[h,i,a])}}function i(a){var d=a.which?3==a.which:2==a.button;a.originalEvent.touches,d||l||e.apply(c,arguments)!==!1&&(l=!0,n=b(c).height(),o=b(c).width(),m=b(c).offset(),b(k).bind(r),b(k.body).addClass("sp-dragging"),q||h(a),g(a))}function j(){l&&(b(k).unbind(r),b(k.body).removeClass("sp-dragging"),f.apply(c,arguments)),l=!1}d=d||function(){},e=e||function(){},f=f||function(){};var k=c.ownerDocument||document,l=!1,m={},n=0,o=0,q="ontouchstart"in a,r={};r.selectstart=g,r.dragstart=g,r[q?"touchmove":"mousemove"]=h,r[q?"touchend":"mouseup"]=j,b(c).bind(q?"touchstart":"mousedown",i)}function m(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,a.apply(e,f)};c&&clearTimeout(d),(c||!d)&&(d=setTimeout(g,b))}}var n={beforeShow:i,move:i,change:i,show:i,hide:i,color:!1,flat:!1,showInput:!1,showButtons:!0,clickoutFiresChange:!1,showInitial:!1,showPalette:!1,showPaletteOnly:!1,showSelectionPalette:!0,localStorageKey:!1,appendTo:"body",maxSelectionSize:7,cancelText:"cancel",chooseText:"choose",preferredFormat:!1,className:"",showAlpha:!1,theme:"sp-light",palette:["fff","000"],selectionPalette:[],disabled:!1},o=[],p=!!/msie/i.exec(a.navigator.userAgent),q=function(){function a(a,b){return!!~(""+a).indexOf(b)}var b=document.createElement("div"),c=b.style;return c.cssText="background-color:rgba(0,0,0,.5)",a(c.backgroundColor,"rgba")||a(c.backgroundColor,"hsla")}(),r=["<div class='sp-replacer'>","<div class='sp-preview'><div class='sp-preview-inner'></div></div>","<div class='sp-dd'>&#9660;</div>","</div>"].join(""),s=function(){var a="";if(p)for(var b=1;6>=b;b++)a+="<div class='sp-"+b+"'></div>";return["<div class='sp-container sp-hidden'>","<div class='sp-palette-container'>","<div class='sp-palette sp-thumb sp-cf'></div>","</div>","<div class='sp-picker-container'>","<div class='sp-top sp-cf'>","<div class='sp-fill'></div>","<div class='sp-top-inner'>","<div class='sp-color'>","<div class='sp-sat'>","<div class='sp-val'>","<div class='sp-dragger'></div>","</div>","</div>","</div>","<div class='sp-hue'>","<div class='sp-slider'></div>",a,"</div>","</div>","<div class='sp-alpha'><div class='sp-alpha-inner'><div class='sp-alpha-handle'></div></div></div>","</div>","<div class='sp-input-container sp-cf'>","<input class='sp-input' type='text' spellcheck='false'  />","</div>","<div class='sp-initial sp-thumb sp-cf'></div>","<div class='sp-button-container sp-cf'>","<a class='sp-cancel' href='#'></a>","<button class='sp-choose'></button>","</div>","</div>","</div>"].join("")}(),t="spectrum.id";b.fn.spectrum=function(a){if("string"==typeof a){var c=this,d=Array.prototype.slice.call(arguments,1);return this.each(function(){var e=o[b(this).data(t)];if(e){var f=e[a];if(!f)throw new Error("Spectrum: no such method: '"+a+"'");"get"==a?c=e.get():"container"==a?c=e.container:"option"==a?c=e.option.apply(e,d):"destroy"==a?(e.destroy(),b(this).removeData(t)):f.apply(e,d)}}),c}return this.spectrum("destroy").each(function(){var c=g(this,a);b(this).data(t,c.id)})},b.fn.spectrum.load=!0,b.fn.spectrum.loadOpts={},b.fn.spectrum.draggable=l,b.fn.spectrum.defaults=n,b.spectrum={},b.spectrum.localization={},b.spectrum.palettes={},b.fn.spectrum.processNativeColorInputs=function(){var a=b("<input type='color' value='!' />")[0],c="color"===a.type&&"!"!=a.value;c||b("input[type=color]").spectrum({preferredFormat:"hex6"})},function(a){function b(a,d){if(a=a?a:"",d=d||{},"object"==typeof a&&a.hasOwnProperty("_tc_id"))return a;var f=c(a),h=f.r,j=f.g,l=f.b,m=f.a,n=w(100*m)/100,o=d.format||f.format;return 1>h&&(h=w(h)),1>j&&(j=w(j)),1>l&&(l=w(l)),{ok:f.ok,format:o,_tc_id:u++,alpha:m,toHsv:function(){var a=g(h,j,l);return{h:360*a.h,s:a.s,v:a.v,a:m}},toHsvString:function(){var a=g(h,j,l),b=w(360*a.h),c=w(100*a.s),d=w(100*a.v);return 1==m?"hsv("+b+", "+c+"%, "+d+"%)":"hsva("+b+", "+c+"%, "+d+"%, "+n+")"},toHsl:function(){var a=e(h,j,l);return{h:360*a.h,s:a.s,l:a.l,a:m}},toHslString:function(){var a=e(h,j,l),b=w(360*a.h),c=w(100*a.s),d=w(100*a.l);return 1==m?"hsl("+b+", "+c+"%, "+d+"%)":"hsla("+b+", "+c+"%, "+d+"%, "+n+")"},toHex:function(a){return i(h,j,l,a)},toHexString:function(a){return"#"+i(h,j,l,a)},toRgb:function(){return{r:w(h),g:w(j),b:w(l),a:m}},toRgbString:function(){return 1==m?"rgb("+w(h)+", "+w(j)+", "+w(l)+")":"rgba("+w(h)+", "+w(j)+", "+w(l)+", "+n+")"},toPercentageRgb:function(){return{r:w(100*k(h,255))+"%",g:w(100*k(j,255))+"%",b:w(100*k(l,255))+"%",a:m}},toPercentageRgbString:function(){return 1==m?"rgb("+w(100*k(h,255))+"%, "+w(100*k(j,255))+"%, "+w(100*k(l,255))+"%)":"rgba("+w(100*k(h,255))+"%, "+w(100*k(j,255))+"%, "+w(100*k(l,255))+"%, "+n+")"},toName:function(){return B[i(h,j,l,!0)]||!1},toFilter:function(a){var c=i(h,j,l),e=c,f=Math.round(255*parseFloat(m)).toString(16),g=f,k=d&&d.gradientType?"GradientType = 1, ":"";if(a){var n=b(a);e=n.toHex(),g=Math.round(255*parseFloat(n.alpha)).toString(16)}return"progid:DXImageTransform.Microsoft.gradient("+k+"startColorstr=#"+p(f)+c+",endColorstr=#"+p(g)+e+")"},toString:function(a){a=a||this.format;var b=!1;return"rgb"===a&&(b=this.toRgbString()),"prgb"===a&&(b=this.toPercentageRgbString()),("hex"===a||"hex6"===a)&&(b=this.toHexString()),"hex3"===a&&(b=this.toHexString(!0)),"name"===a&&(b=this.toName()),"hsl"===a&&(b=this.toHslString()),"hsv"===a&&(b=this.toHsvString()),b||this.toHexString()}}}function c(a){var b={r:0,g:0,b:0},c=1,e=!1,g=!1;return"string"==typeof a&&(a=r(a)),"object"==typeof a&&(a.hasOwnProperty("r")&&a.hasOwnProperty("g")&&a.hasOwnProperty("b")?(b=d(a.r,a.g,a.b),e=!0,g="%"===String(a.r).substr(-1)?"prgb":"rgb"):a.hasOwnProperty("h")&&a.hasOwnProperty("s")&&a.hasOwnProperty("v")?(a.s=q(a.s),a.v=q(a.v),b=h(a.h,a.s,a.v),e=!0,g="hsv"):a.hasOwnProperty("h")&&a.hasOwnProperty("s")&&a.hasOwnProperty("l")&&(a.s=q(a.s),a.l=q(a.l),b=f(a.h,a.s,a.l),e=!0,g="hsl"),a.hasOwnProperty("a")&&(c=a.a)),c=parseFloat(c),(isNaN(c)||0>c||c>1)&&(c=1),{ok:e,format:a.format||g,r:x(255,y(b.r,0)),g:x(255,y(b.g,0)),b:x(255,y(b.b,0)),a:c}}function d(a,b,c){return{r:255*k(a,255),g:255*k(b,255),b:255*k(c,255)}}function e(a,b,c){a=k(a,255),b=k(b,255),c=k(c,255);var d,e,f=y(a,b,c),g=x(a,b,c),h=(f+g)/2;if(f==g)d=e=0;else{var i=f-g;switch(e=h>.5?i/(2-f-g):i/(f+g),f){case a:d=(b-c)/i+(c>b?6:0);break;case b:d=(c-a)/i+2;break;case c:d=(a-b)/i+4}d/=6}return{h:d,s:e,l:h}}function f(a,b,c){function d(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+6*(b-a)*(2/3-c):a}var e,f,g;if(a=k(a,360),b=k(b,100),c=k(c,100),0===b)e=f=g=c;else{var h=.5>c?c*(1+b):c+b-c*b,i=2*c-h;e=d(i,h,a+1/3),f=d(i,h,a),g=d(i,h,a-1/3)}return{r:255*e,g:255*f,b:255*g}}function g(a,b,c){a=k(a,255),b=k(b,255),c=k(c,255);var d,e,f=y(a,b,c),g=x(a,b,c),h=f,i=f-g;if(e=0===f?0:i/f,f==g)d=0;else{switch(f){case a:d=(b-c)/i+(c>b?6:0);break;case b:d=(c-a)/i+2;break;case c:d=(a-b)/i+4}d/=6}return{h:d,s:e,v:h}}function h(a,b,c){a=6*k(a,360),b=k(b,100),c=k(c,100);var d=v.floor(a),e=a-d,f=c*(1-b),g=c*(1-e*b),h=c*(1-(1-e)*b),i=d%6,j=[c,g,f,f,h,c][i],l=[h,c,c,g,f,f][i],m=[f,f,h,c,c,g][i];return{r:255*j,g:255*l,b:255*m}}function i(a,b,c,d){var e=[p(w(a).toString(16)),p(w(b).toString(16)),p(w(c).toString(16))];return d&&e[0].charAt(0)==e[0].charAt(1)&&e[1].charAt(0)==e[1].charAt(1)&&e[2].charAt(0)==e[2].charAt(1)?e[0].charAt(0)+e[1].charAt(0)+e[2].charAt(0):e.join("")}function j(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[a[c]]=c);return b}function k(a,b){n(a)&&(a="100%");var c=o(a);return a=x(b,y(0,parseFloat(a))),c&&(a=parseInt(a*b,10)/100),v.abs(a-b)<1e-6?1:a%b/parseFloat(b)}function l(a){return x(1,y(0,a))}function m(a){return parseInt(a,16)}function n(a){return"string"==typeof a&&-1!=a.indexOf(".")&&1===parseFloat(a)}function o(a){return"string"==typeof a&&-1!=a.indexOf("%")}function p(a){return 1==a.length?"0"+a:""+a}function q(a){return 1>=a&&(a=100*a+"%"),a}function r(a){a=a.replace(s,"").replace(t,"").toLowerCase();var b=!1;if(A[a])a=A[a],b=!0;else if("transparent"==a)return{r:0,g:0,b:0,a:0};var c;return(c=C.rgb.exec(a))?{r:c[1],g:c[2],b:c[3]}:(c=C.rgba.exec(a))?{r:c[1],g:c[2],b:c[3],a:c[4]}:(c=C.hsl.exec(a))?{h:c[1],s:c[2],l:c[3]}:(c=C.hsla.exec(a))?{h:c[1],s:c[2],l:c[3],a:c[4]}:(c=C.hsv.exec(a))?{h:c[1],s:c[2],v:c[3]}:(c=C.hex6.exec(a))?{r:m(c[1]),g:m(c[2]),b:m(c[3]),format:b?"name":"hex"}:(c=C.hex3.exec(a))?{r:m(c[1]+""+c[1]),g:m(c[2]+""+c[2]),b:m(c[3]+""+c[3]),format:b?"name":"hex"}:!1}var s=/^[\s,#]+/,t=/\s+$/,u=0,v=Math,w=v.round,x=v.min,y=v.max,z=v.random;b.fromRatio=function(a,c){if("object"==typeof a){var d={};for(var e in a)a.hasOwnProperty(e)&&(d[e]="a"===e?a[e]:q(a[e]));a=d}return b(a,c)},b.equals=function(a,c){return a&&c?b(a).toRgbString()==b(c).toRgbString():!1},b.random=function(){return b.fromRatio({r:z(),g:z(),b:z()})},b.desaturate=function(a,c){var d=b(a).toHsl();return d.s-=(c||10)/100,d.s=l(d.s),b(d)},b.saturate=function(a,c){var d=b(a).toHsl();return d.s+=(c||10)/100,d.s=l(d.s),b(d)},b.greyscale=function(a){return b.desaturate(a,100)},b.lighten=function(a,c){var d=b(a).toHsl();return d.l+=(c||10)/100,d.l=l(d.l),b(d)},b.darken=function(a,c){var d=b(a).toHsl();return d.l-=(c||10)/100,d.l=l(d.l),b(d)},b.complement=function(a){var c=b(a).toHsl();return c.h=(c.h+180)%360,b(c)},b.triad=function(a){var c=b(a).toHsl(),d=c.h;return[b(a),b({h:(d+120)%360,s:c.s,l:c.l}),b({h:(d+240)%360,s:c.s,l:c.l})]},b.tetrad=function(a){var c=b(a).toHsl(),d=c.h;return[b(a),b({h:(d+90)%360,s:c.s,l:c.l}),b({h:(d+180)%360,s:c.s,l:c.l}),b({h:(d+270)%360,s:c.s,l:c.l})]},b.splitcomplement=function(a){var c=b(a).toHsl(),d=c.h;return[b(a),b({h:(d+72)%360,s:c.s,l:c.l}),b({h:(d+216)%360,s:c.s,l:c.l})]},b.analogous=function(a,c,d){c=c||6,d=d||30;var e=b(a).toHsl(),f=360/d,g=[b(a)];for(e.h=(e.h-(f*c>>1)+720)%360;--c;)e.h=(e.h+f)%360,g.push(b(e));return g},b.monochromatic=function(a,c){c=c||6;for(var d=b(a).toHsv(),e=d.h,f=d.s,g=d.v,h=[],i=1/c;c--;)h.push(b({h:e,s:f,v:g})),g=(g+i)%1;return h},b.readability=function(a,c){var d=b(a).toRgb(),e=b(c).toRgb(),f=(299*d.r+587*d.g+114*d.b)/1e3,g=(299*e.r+587*e.g+114*e.b)/1e3,h=Math.max(d.r,e.r)-Math.min(d.r,e.r)+Math.max(d.g,e.g)-Math.min(d.g,e.g)+Math.max(d.b,e.b)-Math.min(d.b,e.b);return{brightness:Math.abs(f-g),color:h}},b.readable=function(a,c){var d=b.readability(a,c);return d.brightness>125&&d.color>500},b.mostReadable=function(a,c){for(var d=null,e=0,f=!1,g=0;g<c.length;g++){var h=b.readability(a,c[g]),i=h.brightness>125&&h.color>500,j=3*(h.brightness/125)+h.color/500;(i&&!f||i&&f&&j>e||!i&&!f&&j>e)&&(f=i,e=j,d=b(c[g]))}return d};var A=b.names={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"0ff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"00f",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",burntsienna:"ea7e5d",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"0ff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"f0f",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"},B=b.hexNames=j(A),C=function(){var a="[-\\+]?\\d+%?",b="[-\\+]?\\d*\\.\\d+%?",c="(?:"+b+")|(?:"+a+")",d="[\\s|\\(]+("+c+")[,|\\s]+("+c+")[,|\\s]+("+c+")\\s*\\)?",e="[\\s|\\(]+("+c+")[,|\\s]+("+c+")[,|\\s]+("+c+")[,|\\s]+("+c+")\\s*\\)?";return{rgb:new RegExp("rgb"+d),rgba:new RegExp("rgba"+e),hsl:new RegExp("hsl"+d),hsla:new RegExp("hsla"+e),hsv:new RegExp("hsv"+d),hex3:/^([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/}}();a.tinycolor=b}(this),b(function(){b.fn.spectrum.load&&b.fn.spectrum.processNativeColorInputs()})}(window,jQuery),function(a){function b(a,b){if(!(a.originalEvent.touches.length>1)){a.preventDefault();var c=a.originalEvent.changedTouches[0],d=document.createEvent("MouseEvents");d.initMouseEvent(b,!0,!0,window,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null),a.target.dispatchEvent(d)}}if(a.support.touch="ontouchend"in document,a.support.touch){var c,d=a.ui.mouse.prototype,e=d._mouseInit;d._touchStart=function(a){var d=this;!c&&d._mouseCapture(a.originalEvent.changedTouches[0])&&(c=!0,d._touchMoved=!1,b(a,"mouseover"),b(a,"mousemove"),b(a,"mousedown"))},d._touchMove=function(a){c&&(this._touchMoved=!0,b(a,"mousemove"))},d._touchEnd=function(a){c&&(b(a,"mouseup"),b(a,"mouseout"),this._touchMoved||b(a,"click"),c=!1)},d._mouseInit=function(){var b=this;b.element.bind("touchstart",a.proxy(b,"_touchStart")).bind("touchmove",a.proxy(b,"_touchMove")).bind("touchend",a.proxy(b,"_touchEnd")),e.call(b)}}}(jQuery),$(function(){var a='<div class="showpanel"><button class="button show-load icon-folder-open">app</button></div><div class="panel"><div class="choosepanel"><button class="button show-load icon-folder-open">app</button><button class="button close icon-cancel" title="close menu"></button></div><div class="menu menu-load"><div class="controls"><form class="loadfromgist"><input class="loadfromgistinput" name="loadfromgistinput" placeholder="load app from gist url" type="text" /><button class="loadfromgistsubmit icon-ok" type="submit">load</button></form></div><div class="listing"><button class="button newblank icon-doc" title="new blank app">new</button><div class="currentapp"></div><div class="localapps"><h1>Saved Apps</h1></div><div class="examples"><h1>Examples</h1></div></div></div></div>',b='<h1>Current App</h1><div class="info"><h2 title="url, click to edit" class="seturl editable"></h2><p title="title, click to edit" class="settitle editable"></p><p title="description, click to edit" class="setdescription editable"></p></div><div class="savecontrols"><button class="savelocal icon-install">save local</button><button class="forklocal icon-split" title="save as... copy app and save under a new name">fork</button><button class="savegist icon-globe-1" title="save app to gist.github.com anonymously">save public</button><button class="deletelocal icon-trash" title="delete local app"></button></div><div class="permalink" title="last publicly saved version"></div>';window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}();var c=Backbone.View.extend({tagName:"div",className:"app",template:_.template(a),currentTemplate:_.template(b),frameCount:0,NativeNodes:{},plugins:{},events:{"click .close":"closePanels","click .show-load":"showLoad","click .newblank":"newBlank","submit .loadfromgist":"loadFromGist","click .savegist":"saveGist","click .savelocal":"saveLocal","click .forklocal":"forkLocal","click .deletelocal":"deleteLocal","blur .settitle":"setTitle","blur .setdescription":"setDescription","blur .seturl":"setUrl"},initialize:function(){this.render(),$("body").prepend(this.el),this.closePanels(),this.once("allLoaded",this.loadLocalApps,this)},allLoaded:function(){this.trigger("allLoaded"),window.requestAnimationFrame(this.renderAnimationFrame.bind(this))},render:function(){return this.$el.html(this.template()),this},renderAnimationFrame:function(a){a=void 0!==a?a:Date.now(),window.requestAnimationFrame(this.renderAnimationFrame.bind(this)),this.graph&&this.graph.view&&this.graph.view.renderAnimationFrame(a)},graph:null,shownGraph:null,wireColors:["#FF9292","#00C2EE","#DCA761","#8BB0FF","#96BD6D","#E797D7","#29C6AD"],wireColorIndex:0,selectedPort:null,getWireColor:function(){var a=this.wireColors[this.wireColorIndex];return this.wireColorIndex++,this.wireColorIndex>this.wireColors.length-1&&(this.wireColorIndex=0),a},addMenu:function(a,b,c){var d=this,e=$('<div class="menu menu-'+a+'"></div>').append(b).hide();this.$(".panel").append(e);var f=$('<button class="button show-'+a+'">'+a+"</button>").click(function(){d.showPanel(a)});c&&f.addClass(c),this.$(".showpanel").append(f),this.$(".choosepanel > .close").before(f.clone(!0))},addMenuSection:function(a,b,c){var d=$("<h1>").text(a);this.$(".menu-"+c+" .listing").append(d,b)},loadGraph:function(a){return this.graph&&(this.graph.remove(),this.graph=null),this.wireColorIndex=0,this.graph=new Iframework.Graph(a),a.info&&a.info.title&&(document.title="Meemoo: "+a.info.title),this.updateCurrentInfo(),this.shownGraph=this.graph,this.graph},showGraph:function(a){this.shownGraph&&this.shownGraph.view&&this.shownGraph.view.$el.hide(),a.view||a.initializeView(),this.shownGraph=a,this.shownGraph.view.$el.show(),this.shownGraph.view.unhidden||(this.shownGraph.view.unhidden=!0,this.shownGraph.view.rerenderEdges())
},gotMessage:function(a){if(Iframework.graph){var b=Iframework.graph.get("nodes").get(a.data.nodeid);if(b)for(var c in a.data)if(a.data.hasOwnProperty(c)){var d=a.data[c];switch(c){case"message":b.sendFromFrame(d);break;case"info":b.infoLoaded(d);break;case"addInput":b.addInput(d);break;case"addOutput":b.addOutput(d);break;case"stateReady":b.iframeLoaded();break;case"set":b.setValues(d)}}}},_exampleGraphs:[],_loadedExample:null,loadExampleApps:function(a){this._exampleGraphs=this._exampleGraphs.concat(a);for(var b="",c=0;c<a.length;c++){var d=a[c].info.url;d&&(b+='<a href="#example/'+d+'" title="'+a[c].info.title+": "+a[c].info.description+'">'+d+"</a> <br />")}this.$(".menu-load .examples").append(b),this.graph||(this._loadedExample?this.loadExample(this._loadedExample):this._loadedLocal||this._loadedLocal||this._loadedGist||this.newBlank())},loadExample:function(a){this._loadedExample=a;for(var b=0;b<this._exampleGraphs.length;b++)if(this._exampleGraphs[b].info.url===a)return this._loadedLocalApp=null,this.loadGraph(this._exampleGraphs[b]),this.analyze("load","example",a),!0},closePanels:function(){this.$(".showpanel").show(),this.$(".panel").hide(),this.$(".graph").css("right","0px"),this.$(".menu").hide()},showPanel:function(a){if(this.$(".menu").hide(),this.$(".showpanel").hide(),this.$(".panel").show(),this.$(".graph").css("right","350px"),a)if(this.$(".menu-"+a).length>0)this.$(".menu-"+a).show(),this.trigger("showmenu:"+a);else{var b=this;_.delay(function(){b.$(".menu-"+a).show(),b.trigger("showmenu:"+a)},1e3)}},showLoad:function(){this.showPanel(),this.$(".menu-load").show()},loadFromGist:function(){var a=this.loadFromGistId(this.$(".loadfromgistinput").val());return a&&($(".loadfromgistinput").blur(),this.router&&this.router.navigate("gist/"+a),this.$(".loadfromgistinput").val("").attr("placeholder","loading..."),window.setTimeout(function(){this.$(".loadfromgistinput").attr("placeholder","load app from gist url")},1500)),!1},loadFromGistId:function(a){this._loadedGist=a;var b=a.split("/");return b.length>3&&"gist.github.com"===b[2]&&(a=b[b.length-1]),$.ajax({url:"https://api.github.com/gists/"+a,type:"GET",dataType:"jsonp"}).success(function(a){var b=[];for(var c in a.data.files)if(a.data.files.hasOwnProperty(c)){var d=JSON.parse(a.data.files[c].content);if(d){var e=a.data.html_url;d.info.parents&&d.info.parents.push||(d.info.parents=[]),-1===d.info.parents.indexOf(e)&&d.info.parents.push(e),b.push(d)}}b.length>0&&(Iframework.loadGraph(b[0]),Iframework.closePanels())}).error(function(a){console.warn("gist load error",a)}),this.analyze("load","gist",a),a},saveGist:function(){var a=this.graph.toJSON(),b={description:"meemoo app: "+a.info.title,"public":!0};b.files={};var c=a.info.url+".json";b.files[c]={content:JSON.stringify(a,null,"  ")},this.$(".savegist").prop("disabled",!0).text("saving..."),$.ajax({url:"https://api.github.com/gists",type:"POST",dataType:"json",data:JSON.stringify(b)}).success(function(b){var c=Iframework.graph.get("info");c.hasOwnProperty("parents")&&c.parents.push||(a.info.parents=[]),a.info.parents.push(b.html_url),Iframework.saveLocal(),Iframework.updateCurrentInfo(),Iframework.analyze("save","gist",b.id)}).error(function(a){var b="meemoo app: "+Iframework.graph.toJSON().info.title;Iframework.$(".permalink").html('api is down (;_;) copy your app source code to <a href="https://gist.github.com/?description='+encodeURIComponent(b)+'" target="_blank">gist.github.com</a>'),console.warn("gist save error",a)}).complete(function(){this.$(".savegist").prop("disabled",!1).text("save public")})},loadLocalApps:function(){this._localApps=new Iframework.LocalApps,this._localApps.fetch({success:function(){Iframework._localApps.each(function(a){a.initializeView()}),Iframework.graph||Iframework._loadedLocal&&Iframework.loadLocal(Iframework._loadedLocal)},error:function(){console.warn("error loading local apps")}})},_loadedLocal:null,_loadedLocalApp:null,loadLocal:function(a){if(this._loadedLocal=a,this._localApps){var b=this._localApps.getByUrl(a);return b?(b.load(),!0):(console.warn("Didn't find local app with matching url."),this.newBlank(),!1)}return!1},setKey:function(a){var b=window.prompt("Enter a url key",a);return b&&(b=this.encodeKey(b),this.graph.setInfo("url",b)),b},encodeKey:function(a){return a=a.toLowerCase().replace(/ /g,"-"),a=encodeURIComponent(a)},saveLocal:function(){for(this.graph.get("info")||this.graph.set({info:{}});!this.graph.get("info").hasOwnProperty("url")||""===this.graph.get("info").url;){var a;if(a=this.graph.get("info").hasOwnProperty("title")&&""!==this.graph.get("info").title?this.graph.get("info").title:"app-"+(new Date).getTime(),!this.setKey(a))return!1}var b,c=JSON.parse(JSON.stringify(this.graph)),d=c.info.url;if(this._loadedLocalApp)if(this._localApps.getByUrl(d)&&this._localApps.getByUrl(d)!==this._loadedLocalApp){if(!window.confirm('"'+d+'" already exists as a local app. Do you want to replace it?'))return!1;b=this._localApps.updateOrCreate(c)}else b=this._loadedLocalApp,b.save({graph:c}),b.trigger("change");else{if(this._localApps.getByUrl(d)&&!window.confirm('"'+d+'" already exists as a local app. Do you want to replace it?'))return!1;b=this._localApps.updateOrCreate(c)}return this._loadedLocalApp=b,this.analyze("save","local","x"),this.updateCurrentInfo(),Iframework.router.navigate("local/"+d),b},forkLocal:function(){this._loadedLocalApp=null;var a=this.graph.get("info").url+"-copy";this.setKey(a),this.saveLocal()},deleteLocal:function(){this._loadedLocalApp&&(this._loadedLocalApp.destroy(),this._loadedLocalApp=null)},setTitle:function(){var a=this.$(".currentapp .info .settitle").text();a!==this.graph.get("info").title&&this.graph.setInfo("title",a)},setDescription:function(){var a=this.$(".currentapp .info .setdescription").text();a!==this.graph.get("info").description&&this.graph.setInfo("description",a)},setUrl:function(){var a=this.$(".currentapp .info .seturl").text();a=this.encodeKey(a),a!==this.graph.get("info").url&&this.graph.setInfo("url",a)},updateCurrentInfo:function(){var a=this.graph.toJSON();if(this.$(".currentapp").html(this.currentTemplate(a)),this.$(".currentapp .seturl").text(decodeURIComponent(a.info.url)),this.$(".currentapp .settitle").text(a.info.title),this.$(".currentapp .setdescription").text(a.info.description),this.$(".editable").attr("contenteditable","true"),a.info.hasOwnProperty("parents")){var b=a.info.parents;if(b.length>0){var c=b[b.length-1],d=c.split("/");if(d.length>0){var e=d[d.length-1],f="http://meemoo.org/iframework/#gist/"+e,g=encodeURIComponent(f),h=encodeURIComponent(a.info.title),i=$("<span />").text(f).click(function(a){var b;if(document.body.createTextRange)b=document.body.createTextRange(),b.moveToElementText(a.target),b.select();else if(window.getSelection){var c=window.getSelection();b=document.createRange(),b.selectNodeContents(a.target),c.removeAllRanges(),c.addRange(b)}}),j=$('<a title="your saved gist" target="_blank" class="share icon-github"></a>').attr("href",c),k=$('<a title="share on facebook" target="_blank" class="share icon-facebook-rect"></a>').attr("href","https://www.facebook.com/sharer.php?u="+g+"&t="+h),l=" "+a.info.title+" #meemoo "+a.info.description;l.length>=120&&(l=l.substr(0,115)+"..."),l=f+l;var m=$('<a title="post to twitter" target="_blank" class="share icon-twitter-bird"></a>').attr("href","https://twitter.com/intent/tweet?text="+encodeURIComponent(l));this.$(".currentapp .permalink").empty().append(i).append(" ").append(j).append(k).append(m)}}}this._loadedLocalApp?this.$(".currentapp .deletelocal").show():this.$(".currentapp .deletelocal").hide()},newBlank:function(){this.loadGraph({info:{author:"meemoo",title:"Untitled",description:"Meemoo app description",parents:[],url:""},nodes:[],edges:[]}),this._loadedLocalApp=null,this.showPanel("library"),Iframework.router.navigate("new")},analyze:function(){}});window.Iframework=new c,window.addEventListener("message",Iframework.gotMessage,!1)}),$(function(){Iframework.util={types:{undefined:"undefined",number:"number","boolean":"boolean",string:"string","[object Function]":"function","[object RegExp]":"regexp","[object Array]":"array","[object Date]":"date","[object Error]":"error","[object HTMLCanvasElement]":"HTMLCanvasElement","[object ImageData]":"ImageData"},type:function(a){return this.types[typeof a]||this.types[Object.prototype.toString.call(a)]||(a?"object":"null")},imageTypes:["png","gif","jpg","jpeg","webp"],isImageURL:function(a){var b=a.split(".");if(b.length>1){var c=b[b.length-1];return this.imageTypes.indexOf(c)>-1}return!1},imageDrop:function(a,b){if(!b)return!1;a.stopPropagation();var c=a.data.self,d=b.helper.data("meemoo-drag-type");if(!d||"canvas"!==d)return!1;var e=a.data.inputName;if(!e)return!1;var f,g=b.helper.data("meemoo-image-url");if(g){var h=new Image;h.crossOrigin="anonymous",h.onload=function(){f=document.createElement("canvas");var a=f.getContext("2d");f.width=h.width,f.height=h.height,a.drawImage(h,0,0),c.receive(e,f)},h.src=g}else{if(f=b.helper.data("meemoo-drag-canvas"),!f)return!1;c.receive(e,f)}},fitAndCopy:function(a,b){var c,d,e,f,g=b.width,h=b.height,i=g/h,j=a.width,k=a.height,l=j/k;i>=l?(e=j,f=Math.floor(j/i),c=0,d=Math.floor((k-f)/2)):(e=Math.floor(k*i),f=k,c=Math.floor((j-e)/2),d=0);var m=b.getContext("2d");m.drawImage(a,c,d,e,f,0,0,g,h)},DumpObjectIndented:function(a,b){var c="";if("object"==typeof a){(null===b||void 0===b)&&(b="");for(var d in a){var e=a[d];if("string"==typeof e)e="'"+e+"'";else if("object"==typeof e)if(e instanceof Array)e="[ "+e+" ]";else{var f=this.DumpObjectIndented(e,b+"  ");e="\n"+b+"{\n"+f+"\n"+b+"}"}c+=b+"'"+d+"' : "+e+",\n"}}else c=""+a;return c.replace(/,\n$/,"")}}}),$(function(){Iframework.Event=Backbone.Model.extend({defaults:function(){return{action:"",args:{}}},initialize:function(){}}),Iframework.EventsHistory=Backbone.Collection.extend({model:Iframework.Event}),Mousetrap.bind(["command+z","ctrl+z"],function(){var a=window.Iframework.shownGraph,b=a.eventsHistory.last();if("removeNode"===b.get("action")){var c=b.get("args").node,d=a.usedIds.indexOf(c.get("id"));a.usedIds.splice(d,1),a.addNode(c);var e;for(e=0;e<c.Inputs.length;e++)c.view.addInput(c.Inputs.at(e));for(e=0;e<c.Outputs.length;e++)c.view.addOutput(c.Outputs.at(e));var f=b.get("args").edges;for(e=0;e<f.length;e++)a.addEdge(f[e])}a.eventsHistory.pop()})}),$(function(){Iframework.LocalApp=Backbone.Model.extend({initializeView:function(){return this.view||(this.view=new Iframework.LocalAppView({model:this})),this.view},load:function(){Iframework._loadedLocalApp=this;var a=JSON.parse(JSON.stringify(this.get("graph")));Iframework.loadGraph(a)},toJSON:function(){return{id:this.id,graph:this.get("graph")}}}),Iframework.LocalApps=Backbone.Collection.extend({model:Iframework.LocalApp,localStorage:new Backbone.LocalStorage("LocalApps"),getByUrl:function(a){var b=this.find(function(b){return b.get("graph").info.url===a});return b},updateOrCreate:function(a){var b;return b=this.find(function(b){return b.get("graph").info.url===a.info.url}),b?(b.save({graph:a}),b.trigger("change")):(b=this.create({graph:a}),b.initializeView()),b}})}),$(function(){var a='<a class="url" href="#local/<%= graph.info.url %>"></a> - <a class="macro" title="load as subgraph into current graph" href="#">sub</a> ';Iframework.LocalAppView=Backbone.View.extend({tagName:"div",className:"localapp",template:_.template(a),events:{"click .macro":"loadAsMacro"},initialize:function(){return this.render(),Iframework.$(".localapps").append(this.el),this.model.on("change",this.update,this),this.model.on("destroy",this.remove,this),this},render:function(){this.$el.html(this.template(this.model.toJSON())),this.$(".url").text(decodeURIComponent(this.model.get("graph").info.url))},update:function(){this.render(),Iframework.updateCurrentInfo()},loadAsMacro:function(a){return a.preventDefault(),Iframework.shownGraph.addNode({src:"meemoo:subgraph/subgraph",state:{label:decodeURIComponent(this.model.get("graph").info.url),graph:this.model.get("graph")}}),!1},remove:function(){this.$el.remove()}})}),$(function(){Iframework.Graph=Backbone.Model.extend({loaded:!1,defaults:{info:{author:"meemoo",title:"Untitled",description:"Meemoo app description",parents:[],url:""},nodes:[],edges:[]},usedIds:[],edgeCount:0,eventsHistory:[],isSubgraph:!1,initialize:function(){var a=this.get("parentGraph");if(a&&(this.isSubgraph=!0,this.parentGraph=a),this.usedIds=[],this.attributes.nodes){var b=this.attributes.nodes;this.attributes.nodes=new Iframework.Nodes;for(var c=0;c<b.length;c++){var d=this.makeNode(b[c]);d&&this.addNode(d)}}if(this.attributes.edges){var e=this.attributes.edges;this.attributes.edges=new Iframework.Edges;for(var f=0;f<e.length;f++){e[f].parentGraph=this;var g=new Iframework.Edge(e[f]);this.addEdge(g)}}this.eventsHistory=new Iframework.EventsHistory;var h=this;_.defer(function(){h.testLoaded()}),this.on("change",this.graphChanged)},testLoaded:function(){var a=!0;return this.get("nodes").each(function(b){b.hasOwnProperty("lazyLoadType")&&(Iframework.NativeNodes.hasOwnProperty(b.lazyLoadType)?b.view&&!b.Native&&b.view.initializeNative():a=!1)},this),a&&this.initializeView(),a},initializeView:function(){this.view||(this.view=new Iframework.GraphView({model:this}))},setInfo:function(a,b){var c=this.get("info");c[a]=b,this.trigger("change")},makeNode:function(a){if(!a.src)return!1;a.parentGraph=this;var b;if(Iframework.util.isImageURL(a.src)){var c=a.src;a.src="meemoo:image/in",a.state||(a.state={}),a.state.url=c}var d=a.src.split(":");if(d.length<2)return!1;if("meemoo"===d[0]){var e=d[d.length-1],f=e.split("/");e=f.join("-");var g=this;f[0]&&f[1]&&yepnope([{test:Iframework.NativeNodes.hasOwnProperty(f[0]),nope:"src/nodes/"+f[0]+".js"},{test:Iframework.NativeNodes.hasOwnProperty(f[0]+"-"+f[1]),nope:"src/nodes/"+f[0]+"-"+f[1]+".js",complete:function(){_.defer(function(){g.testLoaded()})}}]),b=new Iframework.NodeBox(a),b.lazyLoadType=e}else b=new Iframework.NodeBoxIframe(a);return b},addNode:function(a){if(!a.cid&&(a=this.makeNode(a),!a))return!1;var b=this.get("nodes").length,c=parseInt(a.get("id"),10);for(c!==c&&a.set({id:b});this.usedIds.indexOf(a.get("id"))>=0;)b++,a.set({id:b});this.usedIds.push(a.get("id"));for(var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="",f=0;5>f;f++)e+=d.charAt(Math.floor(Math.random()*d.length));return a.frameIndex="frame_"+a.get("id")+"_"+Iframework.frameCount++ +e+"_through",this.get("nodes").add(a),this.view&&this.view.addNode(a),this.trigger("change"),a},addEdge:function(a){var b=this.get("edges").any(function(b){return b.get("source")[0]===a.get("source")[0]&&b.get("source")[1]===a.get("source")[1]&&b.get("target")[0]===a.get("target")[0]&&b.get("target")[1]===a.get("target")[1]});return b?(console.warn("duplicate edge ignored",a),!1):(this.trigger("change"),this.get("edges").add(a))},remove:function(){this.get("nodes").each(function(a){a.remove(!1)}),this.view&&this.view.remove()},removeNode:function(a){var b=[];this.get("edges").each(function(c){c.Source&&c.Target&&(c.Source.parentNode===a||c.Target.parentNode===a)&&b.push(c)},this),_.each(b,function(a){a.remove()}),this.view&&this.view.removeNode(a),this.get("nodes").remove(a),this.eventsHistory.add(new Iframework.Event({action:"removeNode",args:{node:a,edges:b}})),this.trigger("change")},removeEdge:function(a){a.disconnect(),this.get("edges").remove(a),this.view&&this.view.removeEdge(a),this.trigger("change")},checkLoaded:function(){for(var a=0;a<this.get("nodes").length;a++)if(this.get("nodes").at(a).loaded===!1)return!1;this.loaded=!0;var b=this;return setTimeout(function(){b.connectEdges()},500),!0},reconnectEdges:function(){for(var a=0;a<this.get("edges").length;a++)this.get("edges").at(a).disconnect();var b=this;_.delay(function(){b.connectEdges()},500)},connectEdges:function(){this.get("edges").each(function(a){a.connected||a.connect()}),this.get("nodes").each(function(a){a.setState()})},graphChanged:function(){Iframework.trigger("change",this)},toJSON:function(){return{info:this.get("info"),nodes:this.get("nodes"),edges:this.get("edges")}}}),Iframework.Graphs=Backbone.Collection.extend({model:Iframework.Graph})}),$(function(){var a='<div class="edges"><svg class="edgesSvg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" height="300"></svg></div><div class="nodes" /><div class="iframework-graph-nav" style="display:none;"><button class="show-parent-graph">back to parent graph</button></div>';Iframework.GraphView=Backbone.View.extend({tagName:"div",className:"graph",template:_.template(a),events:{click:"click",dragenter:"ignoreDrag",dragover:"ignoreDrag",drop:"drop",selectablestart:"selectableStart",selectablestop:"selectableStop","click .show-parent-graph":"showParentGraph"},unhidden:!1,initialize:function(){this.render(),this.model.isSubgraph&&(this.$(".iframework-graph-nav").show(),this.$el.hide()),Iframework.$el.prepend(this.el),this.edgesSvg=this.$(".edgesSvg")[0],Iframework.$(".panel").is(":visible")&&this.$el.css("right","350px"),this.model.get("nodes").each(this.addNode.bind(this)),this.$el.droppable({accept:".addnode, .canvas, .meemoo-plugin-images-thumbnail"});var a="ontouchstart"in document;a||this.$el.selectable({filter:".module",delay:20}),this.resizeEdgeSVG()},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},renderAnimationFrame:function(a){this.model.get("nodes").each(function(b){b.view.Native&&b.view.Native.renderAnimationFrame(a)})},click:function(){$(".edge-edit").remove(),Iframework.selectedPort=null,this.$(".module").removeClass("active"),this.$(".module").removeClass("ui-selected")},ignoreDrag:function(a){a.originalEvent.stopPropagation(),a.originalEvent.preventDefault()},drop:function(a,b){this.ignoreDrag(a);var c=a.originalEvent.dataTransfer;if(c&&(c.files,c.files.length>0)){var d=c.files[0],e=d.type.split("/"),f={x:this.el.scrollLeft+a.originalEvent.clientX+10,y:this.el.scrollTop+a.originalEvent.clientY+35};if("image"===e[0])f.src="meemoo:image/in",f.state={url:window.URL.createObjectURL(d)},Iframework.shownGraph.addNode(f);else if("video"===e[0])f.src="meemoo:video/player",f.state={url:window.URL.createObjectURL(d)},Iframework.shownGraph.addNode(f);else if("text"===e[0]){var g=new FileReader;g.onload=function(a){f.src="meemoo:ui/textarea",f.state={value:a.target.result},Iframework.shownGraph.addNode(f)},g.readAsText(d)}}if(!b)return!1;var h=b.helper.data("meemoo-drag-type");if(!h)return!1;var i={x:Math.round(this.el.scrollLeft+b.offset.left+10),y:Math.round(this.el.scrollTop+b.offset.top+35)};switch(h){case"library-module":var j=b.draggable.data("module");j&&j.view.dragAddNode(i);break;case"canvas":var k=b.helper.data("meemoo-drag-canvas");if(k){i.src="meemoo:image/in",i.canvas=k;var l=b.helper.data("meemoo-image-url");l&&"http"===l.slice(0,4)&&(i.state={},i.state.url=l),Iframework.shownGraph.addNode(i)}}return!1},addNode:function(a){this.$(".nodes").append(a.initializeView().el),a.lazyLoadType&&a.view.initializeNative()},addEdge:function(a){a.initializeView(),a.Source.view&&a.Source.view.resetRelatedEdges(),a.Target.view&&a.Target.view.resetRelatedEdges()},remove:function(){this.$el.remove()},removeNode:function(a){a.view&&a.view.remove()},removeEdge:function(a){a.Source&&a.Source.view&&a.Source.view.resetRelatedEdges(),a.Target&&a.Target.view&&a.Target.view.resetRelatedEdges(),a.view&&a.view.remove()},resizeEdgeSVG:_.debounce(function(){var a=this.$(".edgesSvg")[0],b=a.getBBox(),c=b.x+b.width+100,d=b.y+b.height+100;100===c&&100===d&&(c=this.$el.width(),d=this.$el.height()),a.getAttribute("width")<c&&a.setAttribute("width",Math.round(c)),a.getAttribute("height")<d&&a.setAttribute("height",Math.round(d))},100),selectableStart:function(){this.maskFrames()},selectableStop:function(){this.unmaskFrames()},selectAll:function(){this.$(".module").addClass("ui-selected")},selectNone:function(){this.$(".module").removeClass("ui-selected")},cut:function(){this.copy();var a;for(a=0;a<Iframework._copied.nodes.length;a++)Iframework._copied.nodes[a].x-=50,Iframework._copied.nodes[a].y-=50;var b=this.$(".module.ui-selected");for(a=0;a<b.length;a++)$(b[a]).data("iframework-node-view").removeModel()},copy:function(){var a,b,c={nodes:[],edges:[]},d=this.$(".module.ui-selected");for(a=0;a<d.length;a++)b=$(d[a]).data("iframework-node-view").model,c.nodes.push(JSON.parse(JSON.stringify(b)));this.model.get("edges").each(function(e){var f,g=!1;for(a=0;a<d.length;a++)b=$(d[a]).data("iframework-node-view").model,e.Source.node===b&&(f=!0),e.Target.node===b&&(g=!0);f&&g&&c.edges.push(JSON.parse(JSON.stringify(e)))},this),Iframework._copied=c},paste:function(){var a=Iframework._copied;if(a&&a.nodes.length>0){var b=[];this.$(".module").removeClass("ui-selected");for(var c=0;c<a.nodes.length;c++){var d=JSON.parse(JSON.stringify(a.nodes[c]));d.x+=50,d.y+=50,d.parentGraph=this.model;var e=this.model.addNode(d);e.copiedFrom=d.id,b.push(e),e.view&&e.view.select()}for(var f=0;f<a.edges.length;f++){for(var g=JSON.parse(JSON.stringify(a.edges[f])),h={source:[],target:[]},i=0;i<b.length;i++){var j=b[i];g.source[0]===j.copiedFrom&&(h.source[0]=j.id),g.target[0]===j.copiedFrom&&(h.target[0]=j.id)}h.source[1]=g.source[1],h.target[1]=g.target[1],h.parentGraph=this.model,h=new Iframework.Edge(h),this.model.addEdge(h)}}},maskFrames:function(){$(".iframe-type").append('<div class="iframemask" />')},unmaskFrames:function(){$(".iframemask").remove()},showParentGraph:function(){this.model.parentGraph&&Iframework.showGraph(this.model.parentGraph)},rerenderEdges:function(){this.model.get("edges").each(function(a){a.view&&a.view.redraw()},this)}})}),$(function(){Iframework.Node=Backbone.Model.extend({send:function(){},receive:function(){},sendFromFrame:function(){},iframeLoaded:function(){}}),Iframework.Nodes=Backbone.Collection.extend({model:Iframework.Node})}),$(function(){Iframework.NodeView=Backbone.View.extend({send:function(a){this.model.send(a)},receive:function(a){this.model.receive(a)}})}),$(function(){Iframework.NodeBox=Iframework.Node.extend({loaded:!1,defaults:function(){return{src:"",x:100,y:400,z:0,w:200,h:210,state:{}}},info:{title:"native-node",description:"extend me"},initialize:function(){this.Inputs=new Iframework.PortsIn,this.Outputs=new Iframework.PortsOut,this.parentGraph=this.get("parentGraph"),this.on("change",this.nodeChanged)},initializeView:function(){return this.view=new Iframework.NodeBoxView({model:this}),this.view},send:function(a,b){var c=this;_.defer(function(){c.trigger("send:"+a,b)})},receive:function(a,b){this.view.Native&&this.view.Native.receive(a,b)},infoLoaded:function(a){this.info=a,this.view&&this.view.infoLoaded(a)},setState:function(){var a=this.get("state");if(a&&this.view.Native)for(var b in a)this.setEquation(b,a[b]),this.view.Native["input"+b]?this.view.Native["input"+b](a[b]):this.view.Native["_"+b]=a[b]},addInput:function(a){void 0===a.id&&(a.id=a.name),a.parentNode=this;var b=this.Inputs.get(a.id);if(b)return b.set(a),void 0;var c=new Iframework.PortIn(a);c.isIn=!0,c.node=this,c.parentGraph=this.parentGraph,this.Inputs.add(c),this.view&&this.view.addInput(c);var d=this.get("state");return a.hasOwnProperty("default")&&""!==a["default"]&&!d.hasOwnProperty(a.name)&&(d[a.name]=a["default"]),c},addOutput:function(a){void 0===a.id&&(a.id=a.name),a.parentNode=this;var b=this.Outputs.get(a.id);if(b)return b.set(a),void 0;var c=new Iframework.PortOut(a);return c.isIn=!1,c.node=this,c.parentGraph=this.parentGraph,this.Outputs.add(c),this.view&&this.view.addOutput(c),c},nodeChanged:function(){this.parentGraph&&this.parentGraph.trigger("change")},remove:function(a){a?this.parentGraph.removeNode(this):this.view&&this.view.remove()},setValues:function(a){for(var b in a)this.setValue(b,a[b]);this.nodeChanged()},setValue:function(a,b){this.setEquation(a,b),this.get("state")[a]=b,this.nodeChanged()},setEquation:function(a,b){if(this.view.Native){var c=this.Inputs.get(a);if(c){var d=c.get("type");("int"===d||"float"===d||"number"===d)&&("="===b.toString().substr(0,1)?this.view.Native.setEquation(a,b.substr(1)):this.view.Native.setEquation(a))}}},toString:function(){return this.info?"Native node "+this.get("id")+": "+this.info.title:"Native node "+this.get("id")},toJSON:function(){return{id:this.id,src:this.get("src"),x:this.get("x"),y:this.get("y"),w:this.get("w"),h:this.get("h"),state:this.get("state")}}}),Iframework.Nodes=Backbone.Collection.extend({model:Iframework.Node})}),$(function(){var a='<div class="module" style="left:<%= get("x")-10 %>px;top:<%= get("y")-30 %>px;width:<%= get("w")+20 %>px;height:<%= get("h")+40 %>px;" ><div class="outer"></div><div class="ports ports-in"></div><div class="ports ports-out"></div><h1 class="title"><span class="module-icon module-icon-small"></span><span class="node-box-title-name">...</span></h1><button title="show controls" type="button" class="showcontrols icon-left-open"></button><div class="controls"><button title="remove module" type="button" class="remove icon-trash"></button><a title="view source" type="button" class="viewsource button icon-cog"></a><button title="hide controls" type="button" class="hidecontrols icon-right-open"></button></div><div class="inner"></div></div>';Iframework.NodeBoxView=Iframework.NodeView.extend({tagName:"div",className:"node",template:_.template(a),events:{"dragstart .module":"dragStart","drag .module":"drag","dragstop .module":"dragStop","resizestart .module":"resizestart","resize .module":"resize","resizestop .module":"resizestop","mousedown .module, .title":"mousedown","click .module, .title":"click","click .showcontrols":"showControls","click .hidecontrols":"hideControls","click .remove":"removeModel"},initialize:function(){this.render(),this.$(".module").data({"iframework-node-view":this}).draggable({handle:"h1",helper:function(){var a=$(this);return $('<div class="ui-draggable-helper" style="width:'+a.width()+"px; height:"+a.height()+'px">')}}).resizable({minHeight:100,minWidth:100,helper:"ui-draggable-helper"}),this.model.lazyLoadType?this.$(".viewsource").attr({href:"src/nodes/"+this.model.lazyLoadType+".js",target:"_blank"}):this.$(".viewsource").hide(),this.$("h1").disableSelection(),this.mousedown()},initializeNative:function(){this.Native||Iframework.NativeNodes.hasOwnProperty(this.model.lazyLoadType)&&(this.Native=new Iframework.NativeNodes[this.model.lazyLoadType]({model:this.model}),this.$(".inner").append(this.Native.$el),this.model.loaded=!0,this.model.parentGraph.checkLoaded())},render:function(){return this.$el.html(this.template(this.model)),this},infoLoaded:function(a){this.$("h1").attr("title",this.model.get("id")+": "+(a.author?"by "+a.author+": ":"")+a.description),this.$(".node-box-title-name").text(a.title),this.model.lazyLoadType&&this.$(".module-icon").addClass("module-icon-"+this.model.lazyLoadType)},_alsoDrag:[],_dragDelta:{},dragStart:function(a){if(a.target===this.$(".module")[0]){this.model.parentGraph.view.maskFrames(),this.$(".module").hasClass("ui-selected")||this.click(a);var b=this;this._alsoDrag=[],this.model.parentGraph.view.$(".ui-selected").each(function(){if(b.$(".module")[0]!==this){var a=$(this),c={left:parseInt(a.css("left"),10),top:parseInt(a.css("top"),10)};a.data("ui-draggable-alsodrag-initial",c);var d=$('<div class="ui-draggable-helper">').css({width:a.width(),height:a.height(),left:c.left,top:c.top});a.parent().append(d),a.data("ui-draggable-alsodrag-helper",d),b._alsoDrag.push(a)}})}},drag:function(a){if(a.target===this.$(".module")[0]&&this._alsoDrag.length){var b=$(a.target).data("ui-draggable"),c=b.originalPosition,d={top:b.position.top-c.top||0,left:b.position.left-c.left||0};_.each(this._alsoDrag,function(a){var b=a.data("ui-draggable-alsodrag-initial"),c=a.data("ui-draggable-alsodrag-helper");c.css({left:b.left+d.left,top:b.top+d.top})})}},dragStop:function(a,b){if(a.target===this.$(".module")[0]){var c=parseInt(b.position.left,10),d=parseInt(b.position.top,10);this.moveToPosition(c,d),this._alsoDrag.length&&(_.each(this._alsoDrag,function(a){a.data("ui-draggable-alsodrag-initial");var b=a.data("ui-draggable-alsodrag-helper"),c=a.data("iframework-node-view");c.moveToPosition(parseInt(b.css("left"),10),parseInt(b.css("top"),10)),b.remove(),a.data("ui-draggable-alsodrag-initial",null),a.data("ui-draggable-alsodrag-helper",null)}),this._alsoDrag=[]),this.model.parentGraph.view.unmaskFrames()}},moveToPosition:function(a,b){this.$(".module").css({left:a,top:b}),this.model.set({x:a+10,y:b+30})},resizestart:function(){this.model.parentGraph.view.maskFrames()},resize:function(){},resizestop:function(a,b){this.model.parentGraph.view.unmaskFrames();var c=b.size.width,d=b.size.height;this.model.set({w:c-20,h:d-40}),this.Native&&this.Native.resize(c,d),this.model.parentGraph.view.resizeEdgeSVG()},mousedown:function(a){var b=0;$("div.module").each(function(){var a=Number($(this).css("z-index"));a>b&&(b=a)}),this.$(".module").css("z-index",b+1),a&&a.stopPropagation()},click:function(a){a.ctrlKey||a.metaKey?this.$(".module").toggleClass("ui-selected"):(this.model.parentGraph.view.$(".ui-selected").removeClass("ui-selected"),this.$(".module").addClass("ui-selected")),a.stopPropagation()},select:function(){this.$(".module").addClass("ui-selected")},addInput:function(a){this.$(".ports-in").append(a.initializeView().el)},addOutput:function(a){this.$(".ports-out").append(a.initializeView().el)},showControls:function(){this.$(".showcontrols").hide(),this.$(".controls").show()},hideControls:function(){this.$(".showcontrols").show(),this.$(".controls").hide()},removeModel:function(){this.model.remove(!0)},remove:function(){this.Native&&this.Native.remove(),this.$el.remove()},refresh:function(){},popout:function(){}})}),$(function(){var a='<div class="info" />';Iframework.NodeBoxNativeView=Backbone.View.extend({tagName:"div",className:"nativenode",template:_.template(a),info:{title:"native-node-view",description:"extend me"},inputs:{},outputs:{},initialize:function(){this.render(),this.model.infoLoaded(this.info);for(var a in this.inputs)if(this.inputs.hasOwnProperty(a)){var b=this.inputs[a];b.name=a,this.model.addInput(b)}for(var c in this.outputs)if(this.outputs.hasOwnProperty(c)){var d=this.outputs[c];d.name=c,this.model.addOutput(d)}return this.initializeCategory(),this.initializeModule(),this},initializeCategory:function(){},initializeModule:function(){},render:function(){return this.$el.html(this.template(this.model)),this},redraw:function(){},_triggerRedraw:!1,_lastRedraw:0,renderAnimationFrame:function(a){this._triggerRedraw&&(this._triggerRedraw=!1,this.redraw(a),this._lastRedraw=a)},set:function(a,b){this.model.setValue(a,b)},send:function(a,b){this.model.send(a,b)},setEquation:function(a,b){if(this.equations||(this.equations={}),b)try{var c=Parser.parse(b);this.equations[a]=c}catch(d){this.equations[a]=function(a){return a.x}}else this.equations[a]&&(this.equations[a]=void 0)},receive:function(a,b){this.equations&&this.equations[a]&&(b=this.equations[a].evaluate({x:b})),this["input"+a]?this["input"+a](b):(this["_"+a]=b,this._triggerRedraw=!0)},toString:function(){return"Native view: "+this.model.get("id")+": "+this.info.title},resize:function(){},connectEdge:function(){},disconnectEdge:function(){},remove:function(){}})}),$(function(){Iframework.NodeBoxIframe=Iframework.NodeBox.extend({initializeView:function(){return this.view=new Iframework.NodeBoxIframeView({model:this}),this.view},info:{title:"iframe-node",description:"extend me"},sendFromFrame:function(a){var b=a.output,c=a.value;"ImageData"===Iframework.util.type(a.value)&&(c=this.makeCanvas(c)),this.send(b,c)},receive:function(a,b){if(this.view&&this.view.iframeloaded){if("HTMLCanvasElement"===Iframework.util.type(b))try{b=b.getContext("2d").getImageData(0,0,b.width,b.height)}catch(c){return!1}var d={};d[a]=b,this.view.iframe.contentWindow.postMessage(d,"*")}else console.error("wat "+this.id+" "+this.frameIndex)},setState:function(){var a=this.get("state");
a&&this.receive({setState:a})},iframeLoaded:function(){this.loaded=!0,this.parentGraph.checkLoaded()},toString:function(){return this.info?"Iframe node "+this.get("id")+": "+this.info.title:"Iframe node "+this.get("id")},makeCanvas:function(a){return this.canvas||(this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d")),(this.canvas.width!==a.width||this.canvas.height!==a.height)&&(this.canvas.width=a.width,this.canvas.height=a.height),this.context.putImageData(a,0,0),this.canvas}}),Iframework.Nodes=Backbone.Collection.extend({model:Iframework.Node})}),$(function(){Iframework.NodeBoxIframeView=Iframework.NodeBoxView.extend({initialize:function(){Iframework.NodeBoxView.prototype.initialize.call(this),this.$("button.remove").after($('<button title="reload iframe" type="button" class="refresh icon-cw"></button>')),this.events["click .refresh"]="refresh",this.$(".inner").addClass("iframe-type");var a=this;this.iframe.onload=function(){a.iframeloaded=!0}},render:function(){return this.$el.html(this.template(this.model)),this.iframe=document.createElement("iframe"),$(this.iframe).attr({"class":"iframe",name:this.model.frameIndex,src:this.model.get("src")}),this.$(".inner").html(this.iframe),this},refresh:function(){this.$("iframe")[0].src=this.model.get("src")}})}),$(function(){Iframework.Port=Backbone.Model.extend({defaults:{name:"",type:"",description:"","default":null},initialize:function(){""===this.get("type")&&this.set("type","all"),this.parentNode=this.get("parentNode"),this.set("type_class",this.get("type").split(":")[0]),this.Edges=new Iframework.Edges},connect:function(a){this.Edges.add(a)},disconnect:function(a){this.Edges.remove(a)},remove:function(){for(;this.Edges.length>0;){var a=this.Edges.at(0);this.parentNode.parentGraph.removeEdge(a)}this.view&&this.view.remove()}}),Iframework.Ports=Backbone.Collection.extend({model:Iframework.Port})}),$(function(){var a='<div class="edge-edit"><button title="close" class="close icon-cancel"></button><h2><%= name %> (<%= type %>)</h2><p><%= description %></p><p><button class="publish-port">Publish</button></p></div>',b='<div class="edge-edit-item" id="<%= model.cid %>"><span><%= label() %></span><button title="disconnect" class="disconnect icon-scissors" type="button"></button></div>';Iframework.PortView=Backbone.View.extend({tagName:"div",className:"port",popupTemplate:_.template(a),edgeEditTemplate:_.template(b),events:{mousedown:"highlightEdge","click .hole":"clickhole","dragstart .hole":"dragstart","drag .hole, .holehelper":"drag","dragstop .hole, .holehelper":"dragstop","dragstart .plugend":"unplugstart","drag .plugend":"unplugdrag","dragstop .plugend":"unplugstop",drop:"drop","click .disconnect":"disconnect","submit .manualinput":"manualinput","click .publish-port":"publishPort"},initialize:function(){return this.render(),this},dragstart:function(a,b){this.model.node.parentGraph.view.maskFrames(),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole").addClass("fade"),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var c=new Iframework.EdgeView;Iframework.edgePreview=c,this.drag(a,b),this.$(".plugend").show(),a.stopPropagation()},drag:function(a,b){if(Iframework.edgePreview){var c=b.offset.left+Iframework.shownGraph.view.el.scrollLeft,d=b.offset.top+8+Iframework.shownGraph.view.el.scrollTop,e=this.portOffsetLeft(),f=this.portOffsetTop(),g={fromX:this.model.isIn?c-2:e,fromY:this.model.isIn?d:f,toX:this.model.isIn?e:c+20,toY:this.model.isIn?f:d};Iframework.edgePreview.setPositions(g),Iframework.edgePreview.redraw()}a.stopPropagation()},dragstop:function(a){this.model.node.parentGraph.view.unmaskFrames(),$(".hole").removeClass("fade highlight"),Iframework.edgePreview.remove(),Iframework.edgePreview=void 0,this.relatedEdges().length<1&&this.$(".plugend").hide(),a.stopPropagation()},drop:function(a,b){if(this.armDelete)this.armDelete=!1;else{var c=$(b.draggable).data("model"),d=this.model,e=this.model.isIn?c:d,f=this.model.isIn?d:c,g=new Iframework.Edge({source:[e.node.get("id"),e.get("name")],target:[f.node.get("id"),f.get("name")],parentGraph:this.model.parentGraph});Iframework.edgePreview&&(g._color=Iframework.edgePreview._color),g.parentGraph.addEdge(g)&&g.connect()}a.stopPropagation()},unpluggingEdge:null,armDeleteTimeout:null,armDelete:!1,topConnectedEdge:function(){var a,b=0;return _.each(this.relatedEdges(),function(c){c.view._z>=b&&(b=c.view._z,a=c)},this),a},unplugstart:function(a){this.model.node.parentGraph.view.maskFrames();var b=this.topConnectedEdge();if(!b)return!1;this.unpluggingEdge=b,this.unpluggingEdge.view.dim(),1===this.relatedEdges().length&&this.$(".plugend").hide();var c=this.model.isIn?this.unpluggingEdge.Source:this.unpluggingEdge.Target;this.$(".plugend").data("model",c),$("div.ports-"+(this.model.isIn?"in":"out")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var d=new Iframework.EdgeView;d.setColor(this.unpluggingEdge.view._color),Iframework.edgePreview=d,this.armDelete=!0,a.stopPropagation()},unplugdrag:function(a,b){if(Iframework.edgePreview&&this.unpluggingEdge){var c=b.offset.left+Iframework.shownGraph.view.el.scrollLeft,d=b.offset.top+6+Iframework.shownGraph.view.el.scrollTop,e=this.model.isIn?this.unpluggingEdge.Source.view:this.unpluggingEdge.Target.view,f=e.portOffsetLeft(),g=e.portOffsetTop(),h={fromX:this.model.isIn?f:c-2,fromY:this.model.isIn?g:d,toX:this.model.isIn?c+20:f,toY:this.model.isIn?d:g};Iframework.edgePreview.setPositions(h),Iframework.edgePreview.redraw()}a.stopPropagation()},unplugstop:function(a,b){this.armDelete&&this.unpluggingEdge?this.model.parentGraph.removeEdge(this.unpluggingEdge):(this.$(".plugend").show(),this.unpluggingEdge.view.undim()),this.armDelete=!1,this.unpluggingEdge=null,this.dragstop(a,b)},clickhole:function(a){$("div.edge-edit").remove();var b=this.$(".hole"),c=this.model.isIn;this.model.get("name");var d=this.popupTemplate(this.model.toJSON());d=$(d),this.$el.append(d),d.children("button.close").button({icons:{primary:"icon-cancel"},text:!1}).click(function(){$("div.edge-edit").remove(),Iframework.selectedPort=null});var e=this.model.get("type").substring(0,3);if(c){var f=!1,g=$("<form />").attr({id:this.model.node.id+"_"+this.model.get("name"),"class":"manualinput"});if("int"===e||"num"===e||"flo"===e)f=!0,g.append($("<input />").attr({type:"number",min:b.data("min"),max:b.data("max"),step:"any",value:this.model.node.get("state")[this.model.get("name")]}));else if("col"===e||"str"===e)f=!0,g.append($("<input />").attr({type:"text",maxlength:b.data("max"),value:this.model.node.get("state")[this.model.get("name")]}));else if("boo"===e){f=!0;var h=this.model.node.get("state")[this.model.get("name")];h=Boolean(h)&&"false"!==h,g.append($("<input />").attr({type:"checkbox",checked:h}))}else"ban"===e&&(g.append("<label>Send bang:</label> "),f=!0);f&&(g.append($("<button></button>").html("send").attr({type:"submit","class":"send",title:"send value to module"}).button({icons:{primary:"icon-ok"},text:!1})),d.append(g))}$("#select_"+this.model.id).button({icons:{primary:"ui-icon-power"}}),this.relatedEdges().length>0&&(d.append("<h2>disconnect</h2>"),_.each(this.relatedEdges(),function(a){var b=this.edgeEditTemplate(a.view);d.append(b)},this)),this.model.get("options")&&this.model.get("options").length>0&&this.$("input").autocomplete({minLength:0,source:this.model.get("options")}),a.stopPropagation()},manualinput:function(){var a,b=this.model.get("name");this.$(".manualinput").children("input")&&(a=this.$(".manualinput").children("input").val()),this.$(".manualinput").children("input:checkbox").length>0&&(a=this.$(".manualinput").children("input:checkbox").is(":checked")?!0:!1),"int"===this.model.get("type")&&(a=parseInt(a,10)),("number"===this.model.get("type")||"float"===this.model.get("type"))&&(a=parseFloat(a)),void 0===a&&(a="!");var c={};return c[b]=a,this.model.node.receive(c),this.model.node.get("state")[b]=a,this.model.node.trigger("change"),!1},disconnect:function(a){var b=this.model.parentGraph.get("edges").getByCid($(a.target).parents(".edge-edit-item").attr("id"));b&&this.model.parentGraph.removeEdge(b),$("div.edge-edit").remove(),Iframework.selectedPort=null,a.stopPropagation()},portOffsetLeft:function(){var a=this.$(".hole").offset();return a?a.left+7+this.model.parentNode.parentGraph.view.el.scrollLeft:0},portOffsetTop:function(){var a=this.$(".hole").offset();return a?a.top+10+this.model.parentNode.parentGraph.view.el.scrollTop:0},_relatedEdges:null,relatedEdges:function(){return null===this._relatedEdges&&(this._relatedEdges=this.model.parentGraph.get("edges").filter(function(a){return a.Source===this.model||a.Target===this.model},this),this._relatedEdges.length>=1?this.$(".plugend").show():this.$(".plugend").hide(),this.model.node.view.resetRelatedEdges()),this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},highlightEdge:function(){if(this.relatedEdges().length>0){var a=this.topConnectedEdge();a&&a.view&&a.view.highlight()}},highlight:function(){var a=this.$(".plugend");a.addClass("highlight"),setTimeout(function(){a.removeClass("highlight")},1e3)},publishPort:function(){}})}),$(function(){Iframework.PortIn=Iframework.Port.extend({defaults:{name:"",type:"",description:"","default":null},initializeView:function(){return this.view=new Iframework.PortInView({model:this}),this.view}}),Iframework.PortsIn=Backbone.Collection.extend({model:Iframework.PortIn})}),$(function(){var a='<div class="portshown portshown-in"><span class="hole hole-in hole-<%= type_class %> icon-login"></span><span class="label"><%= name %></span></div><span class="plugend plugend-in plugend-<%= type_class %>"></span>';Iframework.PortInView=Iframework.PortView.extend({tagName:"div",className:"port",portInTemplate:_.template(a),events:{mousedown:"highlightEdge","click .hole":"clickhole","dragstart .hole":"dragstart","drag .hole, .holehelper":"drag","dragstop .hole, .holehelper":"dragstop","dragstart .plugend":"unplugstart","drag .plugend":"unplugdrag","dragstop .plugend":"unplugstop",drop:"drop","click .disconnect":"disconnect","submit .manualinput":"manualinput","click .publish-port":"publishPort"},render:function(){this.$el.html(this.portInTemplate(this.model.toJSON())),this.$el.addClass("port-in"),this.$(".hole").draggable({helper:function(){return $('<span class="holehelper holehelper-out" />')}}),this.$(".plugend").draggable({helper:function(){return $('<span class="plugendhelper plugendhelper-in" />')}}),this.$(".hole").data({model:this.model});var a="",b=this.model.get("type_class");a="all"===b||"bang"===b?".hole-out, .plugend-in":".hole-out.hole-all, .hole-out.hole-"+b+", .plugend-in.plugend-all, .plugend-in.plugend-"+b,"string"===b&&(a+=", .hole-out.hole-int, .hole-out.hole-float, .plugend-in.plugend-int, .plugend-in.plugend-float"),("int"===b||"float"===b||"number"===b)&&(a+=", .hole-out.hole-int, .hole-out.hole-float, .hole-out.hole-number, .plugend-in.plugend-int, .plugend-in.plugend-float, .plugend-in.plugend-number"),this.$el.droppable({hoverClass:"drophover",accept:a}),this.$(".plugend").hide(),this.$(".portshown").disableSelection()},dragstart:function(a,b){this.model.node.parentGraph.view.maskFrames(),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole").addClass("fade"),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var c=new Iframework.EdgeView;Iframework.edgePreview=c,this.drag(a,b),this.$(".plugend").show(),a.stopPropagation()},drag:function(a,b){if(Iframework.edgePreview){var c=b.offset.left+Iframework.shownGraph.view.el.scrollLeft,d=b.offset.top+8+Iframework.shownGraph.view.el.scrollTop,e=this.portOffsetLeft(),f=this.portOffsetTop(),g={fromX:this.model.isIn?c-2:e,fromY:this.model.isIn?d:f,toX:this.model.isIn?e:c+20,toY:this.model.isIn?f:d};Iframework.edgePreview.setPositions(g),Iframework.edgePreview.redraw()}a.stopPropagation()},dragstop:function(a){this.model.node.parentGraph.view.unmaskFrames(),$(".hole").removeClass("fade highlight"),Iframework.edgePreview.remove(),Iframework.edgePreview=void 0,this.relatedEdges().length<1&&this.$(".plugend").hide(),a.stopPropagation()},drop:function(a,b){if(this.armDelete)this.armDelete=!1;else{var c=$(b.draggable).data("model"),d=this.model,e=this.model.isIn?c:d,f=this.model.isIn?d:c,g=new Iframework.Edge({source:[e.node.id,e.id],target:[f.node.id,f.id],parentGraph:this.model.parentNode.parentGraph});Iframework.edgePreview&&(g._color=Iframework.edgePreview._color),g.parentGraph.addEdge(g)&&g.connect()}a.stopPropagation()},unpluggingEdge:null,armDeleteTimeout:null,armDelete:!1,topConnectedEdge:function(){var a,b=0;return _.each(this.relatedEdges(),function(c){c.view._z>=b&&(b=c.view._z,a=c)},this),a},unplugstart:function(a){this.model.node.parentGraph.view.maskFrames();var b=this.topConnectedEdge();if(!b)return!1;this.unpluggingEdge=b,this.unpluggingEdge.view.dim(),1===this.relatedEdges().length&&this.$(".plugend").hide();var c=this.model.isIn?this.unpluggingEdge.Source:this.unpluggingEdge.Target;this.$(".plugend").data("model",c),$("div.ports-"+(this.model.isIn?"in":"out")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var d=new Iframework.EdgeView;d.setColor(this.unpluggingEdge.view._color),Iframework.edgePreview=d,this.armDelete=!0,a.stopPropagation()},unplugdrag:function(a,b){if(Iframework.edgePreview&&this.unpluggingEdge){var c=b.offset.left+Iframework.shownGraph.view.el.scrollLeft,d=b.offset.top+6+Iframework.shownGraph.view.el.scrollTop,e=this.model.isIn?this.unpluggingEdge.Source.view:this.unpluggingEdge.Target.view,f=e.portOffsetLeft(),g=e.portOffsetTop(),h={fromX:this.model.isIn?f:c-2,fromY:this.model.isIn?g:d,toX:this.model.isIn?c+20:f,toY:this.model.isIn?d:g};Iframework.edgePreview.setPositions(h),Iframework.edgePreview.redraw()}a.stopPropagation()},unplugstop:function(a,b){this.armDelete&&this.unpluggingEdge?this.model.parentGraph.removeEdge(this.unpluggingEdge):(this.$(".plugend").show(),this.unpluggingEdge.view.undim()),this.armDelete=!1,this.unpluggingEdge=null,this.dragstop(a,b)},clickhole:function(a){$("div.edge-edit").remove();var b=this.$(".hole");this.model.isIn;var c=this.model.get("name"),d=this.popupTemplate(this.model.toJSON());d=$(d),this.$el.append(d),d.children("button.close").click(function(){$("div.edge-edit").remove(),Iframework.selectedPort=null});var e=this.model.get("type").substring(0,3),f=!1,g=$("<form />").attr({id:this.model.node.id+"_"+this.model.get("name"),"class":"manualinput",novalidate:""});if(this.model.has("input_template")){f=!0;var h;"string"==typeof this.model.get("input_template")?h=_.template(this.model.get("input_template")):"function"==typeof this.model.get("input_template")&&(h=this.model.get("input_template")),json=this.model.toJSON(),json.value=this.model.node.get("state")[this.model.get("name")],g.append(h(json))}else if("int"===e||"num"===e||"flo"===e)f=!0,g.append($("<input />").attr({value:this.model.node.get("state")[this.model.get("name")],title:'use equations like "=x*100" to change all incoming values'}));else if("col"===e){f=!0;var i=this.model.node.get("state")[this.model.get("name")],j=$("<input />").attr({type:"text",maxlength:140,value:i,style:"width: 90%"});g.append(j);var k=this;j.spectrum({showInitial:!0,showInput:!0,showAlpha:!0,showPalette:!0,palette:[Iframework.wireColors,["red","green","blue","purple","cyan","magenta","yellow"],["black","#333","#666","#999","#AAA","#CCC","white"]],showSelectionPalette:!0,localStorageKey:"iframework.settings.colorPalette",change:function(a){var b=a.toRgbString();j.val(b),k.model.node.receive(c,b),k.model.node.setValue(c,b)},hide:function(){j.show()},beforeShow:function(){j.spectrum("set",j.val()),j.hide()}}).show()}else if("str"===e)f=!0,g.append($("<input />").attr({type:"text",maxlength:b.data("max"),value:this.model.node.get("state")[this.model.get("name")]}));else if("arr"===e){f=!0;var l=this.model.node.get("state")[this.model.get("name")];"array"!==Iframework.util.type(l)&&(l=[]);for(var m="",n=0;n<l.length;n++)m+=(n>0?", ":"")+l[n];g.append($("<input />").attr({type:"text",value:m}))}else if("boo"===e){f=!0;var o=this.model.node.get("state")[this.model.get("name")];o=Boolean(o)&&"false"!==o,g.append($("<input />").attr({type:"checkbox",checked:o}))}else"ban"===e&&(g.append("<label>Send bang:</label> "),f=!0);f&&(g.append($("<button></button>").attr({type:"submit","class":"send icon-ok",title:"send value to module"})),d.append(g)),$("#select_"+this.model.id).button({icons:{primary:"ui-icon-power"}}),this.relatedEdges().length>0&&(d.append("<h2>disconnect</h2>"),_.each(this.relatedEdges(),function(a){var b=this.edgeEditTemplate(a.view);d.append(b)},this)),this.model.get("options")&&this.model.get("options").length>0&&this.$("input").autocomplete({minLength:0,source:this.model.get("options")}),a.stopPropagation()},manualinput:function(){var a,b,c=this.model.get("name"),d=this.model.get("type"),e=d.substring(0,3),f=!0;if(b=this.model.has("input_element")?this.model.get("input_element"):"input",this.$(".manualinput").children(b)&&(a=this.$(".manualinput").children(b).val()),this.$(".manualinput").children("input:checkbox").length>0&&(a=this.$(".manualinput").children("input:checkbox").is(":checked")?!0:!1),("int"===d||"number"===d||"float"===d)&&("string"==typeof a&&"="===a.toString().substr(0,1)||("int"===d?a=parseInt(a,10):("number"===d||"float"===d)&&(a=parseFloat(a)))),"arr"===e)try{a=JSON.parse("["+a+"]")}catch(g){return!1}return void 0===a&&(a="!",f=!1),f&&this.model.node.setValue(c,a),this.model.node.receive(c,a),!1},disconnect:function(a){var b=this.model.parentGraph.get("edges").getByCid($(a.target).parents(".edge-edit-item").attr("id"));b&&this.model.parentGraph.removeEdge(b),$("div.edge-edit").remove(),Iframework.selectedPort=null,a.stopPropagation()},_relatedEdges:null,relatedEdges:function(){return null===this._relatedEdges&&(this._relatedEdges=this.model.parentGraph.get("edges").filter(function(a){return a.Source===this.model||a.Target===this.model},this),this._relatedEdges.length>=1?this.$(".plugend").show():this.$(".plugend").hide()),this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},highlightEdge:function(){if(this.relatedEdges().length>0){var a=this.topConnectedEdge();a&&a.view&&a.view.highlight()}},highlight:function(){var a=this.$(".plugend");a.addClass("highlight"),setTimeout(function(){a.removeClass("highlight")},1e3)},publishPort:function(){var a=this.model.parentNode.parentGraph.addNode({src:"meemoo:subgraph/input",x:100,y:100,w:80,h:60,state:{label:this.model.id},parentGraph:this.model.parentNode.parentGraph}),b=new Iframework.Edge({source:[a.id,"data"],target:[this.model.parentNode.id,this.model.id],parentGraph:this.model.parentNode.parentGraph});this.model.parentNode.parentGraph.addEdge(b)}})}),$(function(){Iframework.PortOut=Iframework.Port.extend({defaults:{name:"",type:"",description:"","default":null},initializeView:function(){return this.view=new Iframework.PortOutView({model:this}),this.view}}),Iframework.PortsOut=Backbone.Collection.extend({model:Iframework.PortOut})}),$(function(){var a='<div class="portshown portshown-out"><span class="label"><%= name %></span><span class="hole hole-out hole-<%= type_class %> icon-logout"></span></div><span class="plugend plugend-out plugend-<%= type_class %>"></span>';Iframework.PortOutView=Iframework.PortView.extend({tagName:"div",className:"port",portOutTemplate:_.template(a),events:{mousedown:"highlightEdge","click .hole":"clickhole","dragstart .hole":"dragstart","drag .hole, .holehelper":"drag","dragstop .hole, .holehelper":"dragstop","dragstart .plugend":"unplugstart","drag .plugend":"unplugdrag","dragstop .plugend":"unplugstop",drop:"drop","click .disconnect":"disconnect","click .publish-port":"publishPort"},render:function(){this.$el.html(this.portOutTemplate(this.model.toJSON())),this.$el.addClass("port-out"),this.$(".hole").draggable({helper:function(){return $('<span class="holehelper holehelper-in" />')}}),this.$(".plugend").draggable({helper:function(){return $('<span class="plugendhelper plugendhelper-out" />')}}),this.$(".hole").data({model:this.model});var a="",b=this.model.get("type_class");"all"===b?a=".hole-in, .plugend-out":(a=".hole-in.hole-all, .hole-in.hole-"+b+", .plugend-out.plugend-all, .plugend-out.plugend-"+b,a+=", .hole-in.hole-bang, .plugend-out.plugend-string"),("int"===b||"float"===b||"number"===b)&&(a+=", .hole-in.hole-string, .plugend-out.plugend-string",a+=", .hole-in.hole-int, .hole-in.hole-float, .hole-out.hole-number, .plugend-out.plugend-int, .plugend-out.plugend-float, .plugend-out.plugend-number"),this.$el.droppable({hoverClass:"drophover",accept:a}),this.$(".plugend").hide(),this.$(".portshown").disableSelection()},dragstart:function(a,b){this.model.node.parentGraph.view.maskFrames(),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole").addClass("fade"),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var c=new Iframework.EdgeView;Iframework.edgePreview=c,this.drag(a,b),this.$(".plugend").show(),a.stopPropagation()},drag:function(a,b){if(Iframework.edgePreview){var c=b.offset.left+Iframework.shownGraph.view.el.scrollLeft,d=b.offset.top+8+Iframework.shownGraph.view.el.scrollTop,e=this.portOffsetLeft(),f=this.portOffsetTop(),g={fromX:this.model.isIn?c-2:e,fromY:this.model.isIn?d:f,toX:this.model.isIn?e:c+20,toY:this.model.isIn?f:d};Iframework.edgePreview.setPositions(g),Iframework.edgePreview.redraw()}a.stopPropagation()},dragstop:function(a){this.model.node.parentGraph.view.unmaskFrames(),$(".hole").removeClass("fade highlight"),Iframework.edgePreview.remove(),Iframework.edgePreview=void 0,this.relatedEdges().length<1&&this.$(".plugend").hide(),a.stopPropagation()},drop:function(a,b){if(this.armDelete)this.armDelete=!1;else{var c=$(b.draggable).data("model"),d=this.model,e=this.model.isIn?c:d,f=this.model.isIn?d:c,g=new Iframework.Edge({source:[e.node.id,e.id],target:[f.node.id,f.id],parentGraph:this.model.parentNode.parentGraph});Iframework.edgePreview&&(g._color=Iframework.edgePreview._color),g.parentGraph.addEdge(g)&&g.connect()}a.stopPropagation()},unpluggingEdge:null,armDeleteTimeout:null,armDelete:!1,topConnectedEdge:function(){var a,b=0;return _.each(this.relatedEdges(),function(c){c.view&&c.view._z>=b&&(b=c.view._z,a=c)},this),a},unplugstart:function(a){this.model.node.parentGraph.view.maskFrames();var b=this.topConnectedEdge();if(!b)return!1;this.unpluggingEdge=b,this.unpluggingEdge.view.dim(),1===this.relatedEdges().length&&this.$(".plugend").hide();var c=this.model.isIn?this.unpluggingEdge.Source:this.unpluggingEdge.Target;this.$(".plugend").data("model",c),$("div.ports-"+(this.model.isIn?"in":"out")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var d=new Iframework.EdgeView;d.setColor(this.unpluggingEdge.view._color),Iframework.edgePreview=d,this.armDelete=!0,a.stopPropagation()},unplugdrag:function(a,b){if(Iframework.edgePreview&&this.unpluggingEdge){var c=b.offset.left+Iframework.shownGraph.view.el.scrollLeft,d=b.offset.top+6+Iframework.shownGraph.view.el.scrollTop,e=this.model.isIn?this.unpluggingEdge.Source.view:this.unpluggingEdge.Target.view,f=e.portOffsetLeft(),g=e.portOffsetTop(),h={fromX:this.model.isIn?f:c-2,fromY:this.model.isIn?g:d,toX:this.model.isIn?c+20:f,toY:this.model.isIn?d:g};Iframework.edgePreview.setPositions(h),Iframework.edgePreview.redraw()}a.stopPropagation()},unplugstop:function(a,b){this.armDelete&&this.unpluggingEdge?this.model.parentGraph.removeEdge(this.unpluggingEdge):(this.$(".plugend").show(),this.unpluggingEdge.view.undim()),this.armDelete=!1,this.unpluggingEdge=null,this.dragstop(a,b)},clickhole:function(a){$("div.edge-edit").remove(),this.$(".hole"),this.model.isIn,this.model.get("name");var b=this.popupTemplate(this.model.toJSON());b=$(b),this.$el.append(b),b.children("button.close").click(function(){$("div.edge-edit").remove(),Iframework.selectedPort=null}),this.model.get("type").substring(0,3),$("#select_"+this.model.id).button({icons:{primary:"ui-icon-power"}}),this.relatedEdges().length>0&&(b.append("<h2>disconnect</h2>"),_.each(this.relatedEdges(),function(a){var c=this.edgeEditTemplate(a.view);b.append(c)},this)),this.model.get("options")&&this.model.get("options").length>0&&this.$("input").autocomplete({minLength:0,source:this.model.get("options")}),a.stopPropagation()},disconnect:function(a){var b=this.model.parentGraph.get("edges").getByCid($(a.target).parents(".edge-edit-item").attr("id"));b&&this.model.parentGraph.removeEdge(b),$("div.edge-edit").remove(),Iframework.selectedPort=null,a.stopPropagation()},_relatedEdges:null,relatedEdges:function(){return null===this._relatedEdges&&(this._relatedEdges=this.model.parentGraph.get("edges").filter(function(a){return a.Source===this.model||a.Target===this.model},this),this._relatedEdges.length>=1?this.$(".plugend").show():this.$(".plugend").hide()),this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},highlightEdge:function(){if(this.relatedEdges().length>0){var a=this.topConnectedEdge();a&&a.view&&a.view.highlight()}},highlight:function(){var a=this.$(".plugend");a.addClass("highlight"),setTimeout(function(){a.removeClass("highlight")},1e3)},publishPort:function(){var a=this.model.parentNode.parentGraph.addNode({src:"meemoo:subgraph/output",x:500,y:500,w:80,h:60,state:{label:this.model.id},parentGraph:this.model.parentNode.parentGraph}),b=new Iframework.Edge({source:[this.model.parentNode.id,this.model.id],target:[a.id,"data"],parentGraph:this.model.parentNode.parentGraph});this.model.parentNode.parentGraph.addEdge(b)}})}),$(function(){Iframework.Module=Backbone.Model.extend({defaults:{src:"",info:{}},initialize:function(){var a=this.get("src").split(":");this.isNative="meemoo"===a[0],this.isNative&&(this.groupAndName=a[1].split("/"))},initializeView:function(){return this.view||(this.view=new Iframework.ModuleView({model:this})),this.view},toJSON:function(){return{src:this.get("src"),info:this.get("info")}}}),Iframework.Modules=Backbone.Collection.extend({model:Iframework.Module,findOrAdd:function(a){var b;return b=this.find(function(b){return b.get("src")===a.get("src")}),b||(b=new Iframework.Module({node:a}),this.add(b)),b}})}),$(function(){var a='<div class="addnode button module-icon" title="<%= info.description %>"></div><h2 class="title" title="<%= src %>"><%= info.title %></h2>';Iframework.ModuleView=Backbone.View.extend({tagName:"div",className:"library-module",template:_.template(a),events:{"click .addnode":"addNode","dragstart .addnode":"dragStart","dragstop .addnode":"dragStop"},initialize:function(){this.render();var a=this;return this.$(".addnode").data({module:this.model}).draggable({helper:function(){var b=$('<div class="addnode-drag-helper module-icon" />').data({"meemoo-drag-type":"library-module"});return a.model.isNative&&b.addClass("module-icon-"+a.model.groupAndName[0]+"-"+a.model.groupAndName[1]),$(".app").append(b),b}}),this.model.isNative&&this.$(".addnode").addClass("module-icon-"+this.model.groupAndName[0]+"-"+this.model.groupAndName[1]),this},render:function(){this.$el.html(this.template(this.model.toJSON()))},addNode:function(a){Iframework.$(".addbyurlinput").val(this.model.get("src")),Iframework.addByUrl(a)},dragAddNode:function(a){a.src=this.model.get("src"),Iframework.shownGraph.addNode(a)},dragStart:function(){Iframework.shownGraph.view.maskFrames()},dragStop:function(){Iframework.shownGraph.view.unmaskFrames()}})}),$(function(){Iframework.Edge=Backbone.Model.extend({defaults:{source:[0,"default"],target:[0,"default"]},initialize:function(){this.parentGraph=this.get("parentGraph")},initializeView:function(){return this.view=new Iframework.EdgeView({model:this}),this.view},Source:null,Target:null,connectTryCount:5,connected:!1,connect:function(){try{this.Source=this.parentGraph.get("nodes").get(this.get("source")[0]).Outputs.get(this.get("source")[1]),this.Target=this.parentGraph.get("nodes").get(this.get("target")[0]).Inputs.get(this.get("target")[1])}catch(a){if(console.warn("Edge source or target port not found, try #"+this.connectTryCount+": "+this.toString()),this.connectTryCount>0){this.connectTryCount--;var b=this;_.delay(function(){b.connect()},1e3)}return!1}return this.Source&&this.Target?(this.Source.connect(this),this.Target.connect(this),this.Source.node.receive({connect:{source:[this.Source.node.id,this.Source.id],target:[this.Target.node.id,this.Target.id]}}),this.parentGraph.view&&this.parentGraph.view.addEdge(this),this.Target.node.view&&this.Target.node.view.Native&&this.Target.node.view.Native.connectEdge(this),this.connected=!0,this.Source.node.on("send:"+this.Source.id,this.send,this),this):!1},send:function(a){this.Target.node.receive(this.Target.id,a)},disconnect:function(){this.Source&&this.Target&&(this.Source.disconnect(this),this.Target.disconnect(this),this.Source.node.receive({disconnect:{source:[this.Source.node.id,this.Source.id],target:[this.Target.node.id,this.Target.id]}}),this.Target.node.view&&this.Target.node.view.Native&&this.Target.node.view.Native.disconnectEdge(this)),this.view&&this.view.remove(),this.Source.node.off("send:"+this.Source.id,this.send,this),this.connected=!1},remove:function(){this.parentGraph.removeEdge(this)},toJSON:function(){return{source:this.get("source"),target:this.get("target")}},toString:function(){return this.get("source")[0]+":"+this.get("source")[1]+"->"+this.get("target")[0]+":"+this.get("target")[1]}}),Iframework.Edges=Backbone.Collection.extend({model:Iframework.Edge})}),$(function(){Iframework.EdgeView=Backbone.View.extend({tagName:"div",className:"edge",positions:null,graphSVGElement:null,elementGroup:null,elementWire:null,elementShadow:null,isPreview:!1,initialize:function(){this.graphSVGElement=this.model?this.model.parentGraph.view.edgesSvg:Iframework.shownGraph.view.edgesSvg,this.positions={fromX:0,fromY:0,toX:0,toY:0},this.model||(this.isPreview=!0),this.model&&this.model._color&&(this._color=this.model._color),this.render(),this.model&&(this._z=this.model.parentGraph.edgeCount++,$(this.elementWire).data({model:this.model}).click(function(a){$(a.target).data("model").view.click(a)}),this.model.Source&&this.model.Source.parentNode.on("change:x change:y change:w change:h",this.redraw,this),this.model.Target&&this.model.Target.parentNode.on("change:x change:y",this.redraw,this))},render:function(){return this.calcPositions(),this.elementGroup=this.makeSVG("g",{transform:"translate("+this.svgX()+","+this.svgY()+")","class":"wire-group"+(this.isPreview?" preview":"")}),this.elementShadow=this.makeSVG("path",{"class":"wire-shadow",d:this.svgPathShadow()}),this.elementWire=this.makeSVG("path",{"class":"wire",d:this.svgPath(),stroke:this.color()}),this.elementGroup.appendChild(this.elementShadow),this.elementGroup.appendChild(this.elementWire),this.graphSVGElement.appendChild(this.elementGroup),this.model&&(this.model.Source.view.$(".plugend").show(),this.model.Target.view.$(".plugend").show(),this.model.parentGraph.view.resizeEdgeSVG()),this},redraw:function(){this.calcPositions(),$(this.elementGroup).attr("transform","translate("+this.svgX()+", "+this.svgY()+")"),$(this.elementWire).attr("d",this.svgPath()),$(this.elementShadow).attr("d",this.svgPathShadow()),this.model?this.model.parentGraph.view.resizeEdgeSVG():Iframework.shownGraph.view.resizeEdgeSVG()},remove:function(){$(this.elementGroup).remove()},setPositions:function(a){this.positions=a},calcPositions:function(){if(this.model){var a=this.model.get("source")[1],b=this.model.get("target")[1];this.positions.fromX=this.model.Source.view.portOffsetLeft("out",a),this.positions.fromY=this.model.Source.view.portOffsetTop("out",a),this.positions.toX=this.model.Target.view.portOffsetLeft("in",b),this.positions.toY=this.model.Target.view.portOffsetTop("in",b)
}},svgX:function(){return Math.min(this.positions.toX,this.positions.fromX)-50},svgY:function(){return Math.min(this.positions.toY,this.positions.fromY)-25},svgW:function(){return Math.abs(this.positions.toX-this.positions.fromX)+100},svgH:function(){return Math.abs(this.positions.toY-this.positions.fromY)+50},pathStraight:35,pathCurve:60,svgPath:function(){var a=this.positions.fromX-this.svgX(),b=this.positions.fromY-this.svgY(),c=this.positions.toX-this.svgX(),d=this.positions.toY-this.svgY();return"M "+a+" "+b+" L "+(a+this.pathStraight)+" "+b+" C "+(a+this.pathCurve)+" "+b+" "+(c-this.pathCurve)+" "+d+" "+(c-this.pathStraight)+" "+d+" L "+c+" "+d},svgPathShadow:function(){var a=this.positions.fromX-this.svgX(),b=this.positions.fromY-this.svgY()+1,c=this.positions.toX-this.svgX(),d=this.positions.toY-this.svgY()+1;return"M "+a+" "+b+" L "+(a+this.pathStraight)+" "+b+" C "+(a+this.pathCurve)+" "+b+" "+(c-this.pathCurve)+" "+d+" "+(c-this.pathStraight)+" "+d+" L "+c+" "+d},color:function(){return this._color?this._color:this.model?(this._color=Iframework.getWireColor(),this._color):Iframework.wireColors[Iframework.wireColorIndex]},setColor:function(a){this._color=a,$(this.elementWire).attr("stroke",a)},label:function(){return this.model.get("source")[0]+":"+this.model.get("source")[1]+'<span class="wiresymbol" style="color:'+this._color+'">&rarr;</span>'+this.model.get("target")[0]+":"+this.model.get("target")[1]},makeSVG:function(a,b){var c=document.createElementNS("http://www.w3.org/2000/svg",a);for(var d in b)"xlink:href"===d?c.setAttributeNS("http://www.w3.org/1999/xlink","href",b[d]):c.setAttribute(d,b[d]);return c},dim:function(){$(this.elementGroup).attr("opacity",.2)},undim:function(){$(this.elementGroup).attr("opacity",1)},click:function(){this._z<this.model.parentGraph.edgeCount-1&&(this.graphSVGElement.appendChild(this.elementGroup),this._z=this.model.parentGraph.edgeCount++),this.highlight()},highlight:function(){var a=$(this.elementShadow);a.attr("class","wire-shadow highlight"),setTimeout(function(){a.attr("class","wire-shadow")},1e3),this.model.Source.view&&this.model.Source.view.highlight(),this.model.Target.view&&this.model.Target.view.highlight()}})}),$(function(){var a=Backbone.Router.extend({routes:{"example/:url":"loadExample","new":"newBlank","local/:url":"loadLocal","gist/https://gist.github.com/:user/:id":"loadGistUgly","gist/:id":"loadGist","*path":"default"},loadExample:function(a){Iframework.loadExample(a)},loadGistUgly:function(a){this.navigate("gist/"+a,{replace:!0}),this.loadGist(a)},loadLocal:function(a){Iframework.loadLocal(a)},loadGist:function(a){Iframework.loadFromGistId(a)},newBlank:function(){Iframework.newBlank()},"default":function(){}});Iframework.router=new a,Backbone.history.start()}),$(function(){var a='<div class="info" />';Iframework.NativeNodes.image=Iframework.NodeBoxNativeView.extend({template:_.template(a),canvas:null,context:null,initializeCategory:function(){var a=this;this.model.view.$("button.remove").after($('<button title="popout" type="button" class="popout icon-popup"></button>').click(function(){a.popout()})),this.canvas=document.createElement("canvas"),this.canvas.width=10,this.canvas.height=10,this.context=this.canvas.getContext("2d"),$(this.canvas).attr({"class":"canvas",id:"canvas-"+this.model.id}).css({maxWidth:"100%",cursor:"pointer"}).draggable({cursor:"pointer",cursorAt:{top:-10,left:-10},helper:function(){var b=$('<div class="drag-image"><h2>Copy this</h2></div>').data({"meemoo-drag-type":"canvas","meemoo-source-node":a});return $(document.body).append(b),_.delay(function(){a.dragCopyCanvas(b)},100),b}});var b;for(var c in this.inputs)if("image"===this.inputs[c].type){b=c;break}b&&(this.$el.append('<div class="drop-indicator"><p class="icon-login">input '+b+"</p></div>"),this.$el.droppable({accept:".canvas, .meemoo-plugin-images-thumbnail",tolerance:"pointer",hoverClass:"drop-hover",activeClass:"drop-active",greedy:!0}),this.$el.on("drop",{self:this,inputName:b},Iframework.util.imageDrop)),this.$el.prepend(this.canvas)},dragCopyCanvas:function(a){if(a){var b=document.createElement("canvas");b.width=this.canvas.width,b.height=this.canvas.height,b.getContext("2d").drawImage(this.canvas,0,0),a.data("meemoo-drag-canvas",b),a.append(b)}},scale:function(){return this.$(".canvas").width()/this.canvas.width},outputs:{image:{type:"image"}},_smoothing:!0,inputsmoothing:function(a){this._smoothing=a,this.context.webkitImageSmoothingEnabled=a,this.context.mozImageSmoothingEnabled=a},exportImage:function(){try{var a=this.canvas.toDataURL();window.open(a)}catch(b){}},popout:function(){if(this.w)return this.popin(),!1;this.localCanvas=this.canvas,this.localContext=this.context,this.w=window.open("","meemooRemoteWindow","menubar=no,location=no,resizable=yes,scrollbars=no,status=no");var a=this;return this.w.addEventListener("unload",function(){a.popin()}),Iframework.popoutModule&&Iframework.popoutModule!==this&&Iframework.popoutModule.popin(),Iframework.popoutModule=this,this.w.document.body.innerHTML="",this.canvas=this.w.document.createElement("canvas"),this.canvas.width=this.localCanvas.width,this.canvas.height=this.localCanvas.height,this.context=this.canvas.getContext("2d"),this.context.drawImage(this.localCanvas,0,0),this.w.document.body.appendChild(this.canvas),this.w.document.body.style.backgroundColor="black",this.w.document.body.style.overflow="hidden",this.w.document.body.style.margin="0px",this.w.document.body.style.padding="0px",this.w.document.title="meemoo.org",this.canvas.style.position="absolute",this.canvas.style.top="0px",this.canvas.style.left="0px",this.canvas.style.width="100%",this.inputsmoothing(this._smoothing),!1},popin:function(){return this.w&&(this.w=null),this.canvas=this.localCanvas,this.context=this.localContext,this.inputsmoothing(this._smoothing),!1}})}),$(function(){var a=$('<div><div class="sourceedit"><textarea /></div><div class="controls"><button class="button sourcerefresh icon-cw" title="refresh the source code">refresh</button><button class="button sourcecompress icon-bag" title="refresh and compress the source code into one line">compress</button><button class="button sourceapply icon-ok" title="reloads the app">apply changes</button></div></div>'),b=a.find("textarea");Iframework.addMenu("source",a,"icon-cog"),Iframework.on("change",function(){if(Iframework.graph&&Iframework.$(".menu-source").is(":visible")){var a=b.prop("scrollTop");b.val(JSON.stringify(Iframework.graph.toJSON(),null,"  ")),b.scrollTop(a)}});var c=function(){b.val(JSON.stringify(Iframework.graph,null,"  "))};a.find(".sourcerefresh").click(c),Iframework.on("showmenu:source",c);var d=function(){b.val(JSON.stringify(Iframework.graph,null,""))};a.find(".sourcecompress").click(d);var e=function(){var a;try{a=JSON.parse(b.val())}catch(d){return!1}if(a){var e=Iframework.loadGraph(a);Iframework._loadedLocalApp=null,c(),e.trigger("change")}return!1};a.find(".sourceapply").click(e)}),$(function(){var a=$('<div><div class="controls"><form class="addbyurl"><input class="addbyurlinput" name="addbyurlinput" placeholder="search or url" type="text" /><button class="addbyurlsubmit icon-ok" type="submit">load</button></form></div><div class="listing"></div></div>');Iframework.addMenu("library",a,"icon-plus"),Iframework.loadLibrary=function(b){var c=[],d=$("<div></div>");for(var e in b)if(b.hasOwnProperty(e)){var f=$('<div class="library-section"></div>');f.append($('<h3><a href="#">'+e+"</a></h3>"));for(var g=$("<div></div>"),h=b[e],i=0;i<h.length;i++){var j=new Iframework.Module(h[i]);j.initializeView(),g.append(j.view.$el);var k={value:j.get("src"),label:j.get("info").title+" - "+j.get("info").description+" - "+j.get("src"),title:j.get("info").title,description:j.get("info").description+" - "+j.get("src")};c.push(k)}f.append(g),d.append(f)}a.find(".listing").append(d),d.children(".library-section").accordion({animate:!1,header:"h3",heightStyle:"content",collapsible:!0,active:!1}),a.find(".addbyurlinput").autocomplete({minLength:1,source:c,select:function(){_.defer(function(){Iframework.addByUrl()})}}).data("ui-autocomplete")._renderItem=function(a,b){return $("<li>").append('<a><span style="font-size:120%;">'+b.title+"</span><br>"+b.description+"</a>").appendTo(a)}};var b=Iframework.addByUrl=function(){var a=Iframework.$(".addbyurlinput");a.blur();var b=a.val();if(""!==b){var c=Iframework.$(".graph");Iframework.shownGraph.addNode({src:b,x:Math.floor(c.scrollLeft()+c.width()/2)-100,y:Math.floor(c.scrollTop()+c.height()/2)-100}),a.val("").attr("placeholder","loading..."),window.setTimeout(function(){a.attr("placeholder","search or url")},1e3)}return!1};a.find(".addbyurl").submit(function(){return b(),!1})}),$(function(){var a="AaqPpE9LORQel03S9cCl7z",b="http://i.meemoo.me/";window.URL||(window.URL=window.webkitURL||window.msURL||window.oURL||!1);var c=$('<div class="meemoo-plugin-images"><div class="listing"><h2>Local images (not saved)</h2><span style="position:absolute;width:0px;overflow:hidden;"><input type="file" class="file-input-local" accept="image/*" multiple /></span><button class="localfile icon-camera" title="Not public. From computer (or mobile camera).">Choose local image</button> from computer or mobile camera<div class="image-drop local-drop"><div class="drop-indicator"><p>drag image here to hold it</p></div></div><div class="thumbnails local-listing"></div><h2>Meemoo.me images (public)</h2><span style="position:absolute;width:0px;overflow:hidden;"><input type="file" class="file-input-public" accept="image/*" /></span><button disabled class="publicfile icon-camera" title="Import from computer (or mobile camera).">Upload</button><button disabled class="publicfile-service icon-globe-1" title="Upload image to Meemoo from computer, URL, Flickr, Google, Dropbox...">Import from Flickr, Dropbox, etc.</button><div class="info"></div><div class="image-drop public-drop"><div class="drop-indicator"><p class="icon-globe-1">drag image here to save to meemoo.me</p></div></div><div class="thumbnails public-listing"></div></div></div>');Iframework.addMenu("images",c,"icon-picture");var d=c.find(".info"),e=function(a){d.text(a)};yepnope({load:"http://api.filepicker.io/v1/filepicker.js",complete:function(){window.filepicker?(filepicker.setKey(a),c.find(".publicfile, .publicfile-service").prop("disabled",!1)):e("Offline or image service not available.")}}),Iframework.$(".show-images").droppable({accept:".canvas, .image",tolerance:"pointer",activeClass:"drop-indicator",over:function(){$(this).trigger("click")}}),c.find(".image-drop").droppable({accept:".canvas",tolerance:"pointer",hoverClass:"drop-hover",activeClass:"drop-active",greedy:!0}),c.find(".public-drop").droppable({accept:".canvas, .image"}),c.find(".local-drop").on("drop",function(a,b){var c=b.helper.data("meemoo-drag-canvas");if(!c)return!1;var d=f(c);i.append(d)});var f=function(a){var b=$('<div class="meemoo-plugin-images-thumbnail canvas">').append(a).draggable({cursor:"pointer",cursorAt:{top:-10,left:-10},helper:function(){var b=$('<div class="drag-image"><h2>Copy this</h2></div>').data({"meemoo-drag-type":"canvas","meemoo-source-image":a});return $(document.body).append(b),_.delay(function(){g(b)},100),b}});return b},g=function(a){if(a){var b=a.data("meemoo-source-image"),c=document.createElement("canvas");c.width=b.naturalWidth?b.naturalWidth:b.width,c.height=b.naturalHeight?b.naturalHeight:b.height,c.getContext("2d").drawImage(b,0,0),a.data("meemoo-drag-canvas",c),a.append(c)}},h=c.find(".file-input-local"),i=c.find(".local-listing");h.change(function(a){for(var b=a.target.files,c=0;c<b.length;c++){var d=new Image;d.src=window.URL.createObjectURL(b[c]);var e=f(d);i.append(e)}}),c.find(".localfile").click(function(){h.trigger("click")});var j=function(a){for(var b=0;b<a.length;b++){var c={main:a[b]},d=new Iframework.plugins.images.GalleryImage({files:c});n.add(d),d.save()}},k=c.find(".public-listing");c.find(".publicfile-service").click(function(){return window.filepicker?(filepicker.pickAndStore({mimetype:"image/*",multiple:!0,maxSize:5242880},{location:"S3",path:"v1/in/",access:"public"},j),void 0):(e("Image service not yet available."),!1)});var l=c.find(".file-input-public");l.change(function(a){return window.filepicker?(a.target.files.length>0&&(e("Uploading..."),filepicker.store(a.target,{location:"S3",path:"v1/in/",access:"public"},function(a){var b=[];b.push(a),j(b)},function(){e("Upload error :-(")},function(a){e(a+"% uploaded.")})),void 0):(e("Image service not yet available."),!1)}),c.find(".publicfile").click(function(){return window.filepicker?(l.trigger("click"),void 0):(e("Image service not yet available."),!1)}),c.find(".public-drop").on("drop",function(a,b){if(!window.filepicker)return e("Image service not available."),!1;var c=b.helper.data("meemoo-drag-canvas"),d=b.helper.data("meemoo-source-image");if(!c&&!d)return!1;var f,g;if(c){try{g=c.toDataURL().split(",",2)[1]}catch(h){return e('Not able to get image data. Right-click "Save as..." or take a screenshot.'),!1}f={mimetype:"image/png",location:"S3",path:"v1/out/",filename:"meemoo.png",access:"public",base64decode:!0}}else if(d){if("data"!==d.src.split(":")[0])return!1;var i=d.src.split(",",2),j=i[0].split(":")[1].split(";")[0],k=j.split("/")[1];g=i[1],f={mimetype:j,location:"S3",path:"v1/out/",filename:"meemoo."+k,access:"public",base64decode:!0}}return g&&f?(e("Uploading..."),filepicker.store(g,f,function(a){var b={main:a},c=new Iframework.plugins.images.GalleryImage({files:b});n.add(c),c.save(),e("Upload done :-)"),_.delay(function(){e("")},2e3)},function(){e("Upload error :-(")},function(a){e(a+"% uploaded.")}),void 0):!1}),Iframework.plugins.images={},Iframework.plugins.images.GalleryImage=Backbone.Model.extend({initialize:function(){this.mainsrc=b+this.get("files").main.key;var a=this.get("files").thumb;if(a&&a.key)this.thumbsrc=b+a.key;else{this.thumbsrc=this.mainsrc;var c=this;_.delay(function(){c.makeThumb()},3e3)}this.initializeView()},initializeView:function(){return this.view||(this.view=new Iframework.plugins.images.GalleryImageView({model:this})),this.view},makeThumb:function(){var a=this,b=this.get("files").main;b&&window.filepicker&&filepicker.convert(b,{fit:"crop",format:"jpg",quality:80,width:100,height:100},{location:"S3",path:"v1/thumbs/",access:"public"},function(b){var c=a.get("files");c.thumb=b,a.save()},function(){})},toJSON:function(){return{id:this.id,files:this.get("files")}}}),Iframework.plugins.images.GalleryImages=Backbone.Collection.extend({model:Iframework.plugins.images.GalleryImage,localStorage:new Backbone.LocalStorage("GalleryImages")});var m='<img crossorigin="anonymous" title="drag to graph or image node" /><div class="controls"><a class="link button icon-link" title="Open image in new window" target="_blank"></a><button class="export-public icon-export" title="Save straight to Flickr, Dropbox, Google, Facebook..."></button><button class="delete icon-trash" title="Delete image"></button></div>';Iframework.plugins.images.GalleryImageView=Backbone.View.extend({tagName:"div",className:"meemoo-plugin-images-thumbnail",template:_.template(m),events:{"click .export-public":"exportPublic","click .delete":"destroyModel"},initialize:function(){this.$el.html(this.template(this.model.toJSON()));var a=this.model.mainsrc;this.$(".link").attr("href",a);var b=this.$("img")[0];return b.src=this.model.thumbsrc,this.$el.draggable({cursor:"pointer",cursorAt:{top:-10,left:-10},helper:function(){var c=$('<div class="drag-image"><h2>Copy this</h2></div>').data({"meemoo-drag-type":"canvas","meemoo-source-image":b,"meemoo-image-url":a});return $(document.body).append(c),_.delay(function(){g(c)},100),c}}),k.prepend(this.el),this.model.on("destroy",this.remove,this),this},exportPublic:function(){if(!window.filepicker)return e("Image service not available."),!1;var a=this.model.get("files").main.url;filepicker.exportFile(a,{mimetype:"image/png"},function(){})},destroyModel:function(){if(window.confirm("Are you sure you want to delete this image?")){if(window.filepicker){var a=this.model.get("files").main;filepicker.remove(a,function(){})}this.model.destroy()}},remove:function(){this.$el.remove()}});var n=new Iframework.plugins.images.GalleryImages;n.fetch({success:function(){n.each(function(a){a.initializeView()})},error:function(){console.warn("error loading public images")}})}),$(function(){Iframework.allLoaded(),Mousetrap.bind(["command+a","ctrl+a"],function(a){Iframework.shownGraph&&Iframework.shownGraph.view&&(a.preventDefault(),Iframework.shownGraph.view.selectAll())}),Mousetrap.bind(["command+x","ctrl+x"],function(){Iframework.shownGraph&&Iframework.shownGraph.view&&Iframework.shownGraph.view.cut()}),Mousetrap.bind(["command+c","ctrl+c"],function(){Iframework.shownGraph&&Iframework.shownGraph.view&&Iframework.shownGraph.view.copy()}),Mousetrap.bind(["command+v","ctrl+v"],function(){Iframework.shownGraph&&Iframework.shownGraph.view&&Iframework.shownGraph.view.paste()})});